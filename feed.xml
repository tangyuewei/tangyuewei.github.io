<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="zh-CN"><generator uri="https://jekyllrb.com/" version="4.2.2">Jekyll</generator><link href="https://tangyuewei.github.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://tangyuewei.github.io/" rel="alternate" type="text/html" hreflang="zh-CN" /><updated>2025-09-02T10:37:14+08:00</updated><id>https://tangyuewei.github.io/feed.xml</id><title type="html">å”æ‚¦ç®</title><subtitle>åŠªåŠ›åªæ˜¯ä¸€ç§ç”Ÿæ´»æ–¹å¼ï¼Œå…ˆæ•¬ä¸šï¼Œå†ä¹ä¸š.</subtitle><entry><title type="html">æ¢…èŠ±æ˜“æ•°èµ·å¦</title><link href="https://tangyuewei.github.io/posts/%E6%A2%85%E8%8A%B1%E6%98%93%E6%95%B0%E8%B5%B7%E5%8D%A6/" rel="alternate" type="text/html" title="æ¢…èŠ±æ˜“æ•°èµ·å¦" /><published>2025-06-15T15:01:00+08:00</published><updated>2025-06-15T15:01:00+08:00</updated><id>https://tangyuewei.github.io/posts/%E6%A2%85%E8%8A%B1%E6%98%93%E6%95%B0%E8%B5%B7%E5%8D%A6</id><content type="html" xml:base="https://tangyuewei.github.io/posts/%E6%A2%85%E8%8A%B1%E6%98%93%E6%95%B0%E8%B5%B7%E5%8D%A6/"><![CDATA[<blockquote>
  <p>è®²ä¸€ä¸ªæ¢…èŠ±æ˜“æ•°çš„èµ·å¦è®¡ç®—æµç¨‹ï¼Œå†ç»“åˆä¸€ä¸ªå®é™…æ¡ˆä¾‹ã€‚</p>
</blockquote>

<h3 id="-ä¸€æ¢…èŠ±æ˜“æ•°çš„èµ·å¦è®¡ç®—æµç¨‹ç”¨æ—¶é—´èµ·å¦æ³•">ğŸŒŸ ä¸€ã€æ¢…èŠ±æ˜“æ•°çš„èµ·å¦è®¡ç®—æµç¨‹ï¼ˆç”¨æ—¶é—´èµ·å¦æ³•ï¼‰</h3>
<p>æˆ‘ä»¬ç”¨ã€å¹´æœˆæ—¥æ—¶ã€‘çš„æ•°å­—æ¥èµ·å¦ã€‚</p>
<ol>
  <li>å‡†å¤‡ï¼šè®°å½•å½“å‰æ—¶é—´
æ¯”å¦‚ä½ ç°åœ¨æƒ³èµ·ä¸€å¦ï¼Œè®°å½•å½“å‰æ—¶é—´å¦‚ä¸‹ï¼ˆå‡è®¾ï¼‰ï¼š
    <ul>
      <li>å¹´ï¼š2025å¹´</li>
      <li>æœˆï¼š6æœˆ</li>
      <li>æ—¥ï¼š13æ—¥</li>
      <li>æ—¶è¾°ï¼š13ç‚¹ï¼ˆåˆå1ç‚¹ï¼Œå¯¹åº”åœ°æ”¯â€œæœªâ€ï¼Œæœª=8ï¼‰</li>
    </ul>
  </li>
</ol>

<hr />

<ol>
  <li>è®¡ç®—ä¸‰ä¸ªå…³é”®æ•°å­—
ğŸ”¹ æ•°å­—â‘ ï¼ˆä¸Šå¦ï¼‰
ç”¨ï¼šå¹´ + æœˆ + æ—¥
= 2025 + 6 + 13 = 2044
å°†2044é™¤ä»¥8ï¼Œå–ä½™æ•°ï¼š
2044 Ã· 8 = 255 ä½™ 4
ğŸ‘‰ ä¸Šå¦ = ç¬¬4å¦ï¼ˆéœ‡å¦ â˜³ï¼‰</li>
</ol>
<hr />

<p>ğŸ”¹ æ•°å­—â‘¡ï¼ˆä¸‹å¦ï¼‰
ç”¨ï¼šæœˆ + æ—¥ + æ—¶è¾°åœ°æ”¯æ•°
= 6 + 13 + 8 = 27
27 Ã· 8 = 3 ä½™ 3
ğŸ‘‰ ä¸‹å¦ = ç¬¬3å¦ï¼ˆç¦»å¦ â˜²ï¼‰</p>

<hr />

<p>ğŸ”¹ æ•°å­—â‘¢ï¼ˆåŠ¨çˆ»ï¼‰
ç”¨ï¼šå¹´ + æœˆ + æ—¥ + æ—¶è¾°
= 2025 + 6 + 13 + 8 = 2052
2052 Ã· 6 = 342 ä½™ 0
ğŸ‘‰ è‹¥ä½™0ï¼Œåˆ™åŠ¨çˆ»ä¸ºç¬¬6çˆ»ï¼ˆä»ä¸‹å¾€ä¸Šæ•°ç¬¬6æ¡çº¿åŠ¨ï¼‰</p>

<hr />

<ol>
  <li>å¾—åˆ°ä¸»å¦ + åŠ¨çˆ»
ä¸Šå¦ï¼šéœ‡ â˜³
ä¸‹å¦ï¼šç¦» â˜²
â†’ åˆæˆä¸»å¦ä¸ºï¼šç«é›·å™¬å—‘ï¼ˆå¦åº21ï¼‰
ç¬¬6çˆ»åŠ¨ â†’ å˜å¦
æŸ¥ã€Šæ˜“ç»ã€‹å¾—çŸ¥ï¼š
    <ul>
      <li>ä¸»å¦ï¼šç«é›·å™¬å—‘ï¼ˆæœ‰å’¬åˆã€çªç ´ã€å¤„ç†çº çº·çš„æ„æ€ï¼‰</li>
      <li>ç¬¬å…­çˆ»åŠ¨ï¼Œçˆ»è¾æ˜¯ï¼šâ€œå§¤å…¶è§’ï¼Œåï¼Œæ— å’ã€‚â€</li>
      <li>å˜å¦ï¼šå› ç¬¬å…­çˆ»åŠ¨ï¼Œå°†ç«é›·å™¬å—‘çš„ç¬¬å…­çˆ»ï¼ˆé˜³å˜é˜´ï¼‰
â†’ å¾—åˆ°å˜å¦ä¸ºï¼šç«é›·å™¬å—‘ å˜ä¸º ç«é›·å¤§å£®</li>
    </ul>
  </li>
</ol>

<hr />

<h3 id="-äºŒå®é™…æ¡ˆä¾‹è§£æ">ğŸ§© äºŒã€å®é™…æ¡ˆä¾‹è§£æ</h3>
<p>ğŸŒŸ é—®é¢˜ï¼šæˆ‘ç°åœ¨è€ƒè™‘æ˜¯å¦åº”è¯¥æ¢å·¥ä½œï¼Œèƒ½ä¸èƒ½é¡ºåˆ©ï¼Ÿ
æˆ‘ä»¬ç”¨ä¸Šé¢èµ·å‡ºæ¥çš„å¦æ¥è§£ï¼š</p>
<ul>
  <li>ä¸»å¦ï¼šç«é›·å™¬å—‘ï¼ˆè±¡å¾æœ‰é—®é¢˜éœ€è¦å¤„ç†ã€å’¬åˆä¹‹è±¡ï¼‰</li>
  <li>å˜å¦ï¼šç«é›·å¤§å£®ï¼ˆå¤§å£®è€…ï¼Œå¤§æœ‰ä½œä¸ºï¼Œæœ‰è¡ŒåŠ¨åŠ›ï¼‰</li>
</ul>

<p>ğŸ” è§£å¦åˆ†æï¼š</p>

<ol>
  <li>
    <p>å¦æ„ï¼šå™¬å—‘å¦æœ¬ä¹‰æ˜¯â€œå’¬åˆâ€ï¼Œè±¡å¾å½“å‰ä½ æ‰€å¤„çš„èŒåœºæœ‰é˜»åŠ›æˆ–é—®é¢˜ï¼Œéœ€è¦å¤„ç†ã€‚å¯èƒ½æœ‰èŒåœºå†²çªã€å‘å±•å—é™ã€å†…éƒ¨æ‘©æ“¦ç­‰ã€‚</p>
  </li>
  <li>
    <p>åŠ¨çˆ»åœ¨ç¬¬å…­çˆ»ï¼ˆé¡¶ç«¯ï¼‰ï¼šä»£è¡¨é—®é¢˜å·²ç»åˆ°äº†â€œå¤´â€ï¼Œæˆ–è€…ä½ å·²ç»è€ƒè™‘å¾ˆä¹…äº†ï¼Œæœ‰å¼ºçƒˆè¡ŒåŠ¨æ¬²æœ›ã€‚ä½†å…­çˆ»åŠ¨ï¼Œä¹Ÿæš—ç¤ºè¿‡åˆšæ˜“æŠ˜ï¼Œè¦æ…é‡ã€‚</p>
  </li>
  <li>
    <p>å˜å¦â€œå¤§å£®â€ ï¼šæ„å‘³ç€ï¼šè‹¥èƒ½å¦¥å–„å¤„ç†è½¬æ¢è¿‡ç¨‹ï¼Œæœ‰å¾ˆå¤§æœºä¼šæˆåŠŸï¼Œä½†è¦æ³¨æ„æ–¹å¼æ–¹æ³•ï¼Œä¸å¯é²è½ï¼Œå¦åˆ™ä¼šå¸¦æ¥å‹åŠ›ã€‚</p>
  </li>
</ol>

<p>ç»“è®ºï¼š
ç›®å‰æ¢å·¥ä½œçš„æ„å›¾å·²ç»æˆç†Ÿï¼Œé—®é¢˜ç§¯ç´¯è¾ƒå¤šï¼›å¦‚æœä½ åšå¥½äº†å‡†å¤‡ï¼Œå¹¶é‡‡å–æœ‰èŠ‚åˆ¶ã€æœ‰ç­–ç•¥çš„è¡ŒåŠ¨ï¼Œæ¢å·¥ä½œæ˜¯å¯è¡Œå¹¶å¯èƒ½æˆåŠŸçš„ã€‚ä½†åˆ‡å¿Œå†²åŠ¨ï¼Œè¦æå‰è§„åˆ’è¿‡æ¸¡æœŸã€ç»æµã€æŠ€èƒ½åŒ¹é…ã€‚</p>

<hr />

<p>ğŸ“ æ€»ç»“</p>

<p>æ­¥éª¤å†…å®¹ï¼šè®°å½•æ—¶é—´å¹´æœˆæ—¥æ—¶è¾°ä¸‰æ¬¡å–ä½™æ•°å¾—ä¸Šå¦ã€ä¸‹å¦ã€åŠ¨çˆ»æŸ¥ä¸»å¦ï¼Œé€šè¿‡å…«å¦å¯¹åº”å…³ç³»æŸ¥å¾—å…­åå››å¦è§£åŠ¨çˆ»æŸ¥åŠ¨çˆ»çˆ»è¾ï¼Œå¾—å˜å¦ç»¼åˆè§£å¦è§£è¯»ä¸»å¦ + åŠ¨çˆ» + å˜å¦</p>

<hr />

<p><a href="https://tangyuewei.com/laiyigua/">æ¥ä¸€å¦å§</a></p>]]></content><author><name>tangyuewei</name></author><category term="å‘¨æ˜“" /><category term="å‘¨æ˜“" /><category term="å åœ" /><summary type="html"><![CDATA[è®²ä¸€ä¸ªæ¢…èŠ±æ˜“æ•°çš„èµ·å¦è®¡ç®—æµç¨‹ï¼Œå†ç»“åˆä¸€ä¸ªå®é™…æ¡ˆä¾‹ã€‚]]></summary></entry><entry><title type="html">å åœå åœ</title><link href="https://tangyuewei.github.io/posts/%E5%8D%A0%E5%8D%9C%E5%8D%A0%E5%8D%9C/" rel="alternate" type="text/html" title="å åœå åœ" /><published>2025-06-14T10:20:00+08:00</published><updated>2025-06-14T10:20:00+08:00</updated><id>https://tangyuewei.github.io/posts/%E5%8D%A0%E5%8D%9C%E5%8D%A0%E5%8D%9C</id><content type="html" xml:base="https://tangyuewei.github.io/posts/%E5%8D%A0%E5%8D%9C%E5%8D%A0%E5%8D%9C/"><![CDATA[<h2 id="å¤äººä¸€èˆ¬ä»€ä¹ˆæ—¶å€™å åœ">å¤äººä¸€èˆ¬ä»€ä¹ˆæ—¶å€™å åœï¼Ÿ</h2>

<p>å¤ä»£ä¸­å›½å åœçš„æ—¶é—´å’Œåœºåˆå¤šç§å¤šæ ·ï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p>
<ol>
  <li>é‡å¤§å†³ç­–ä¹‹å‰
  æ¯”å¦‚å‡ºå¾æ‰“ä»—ã€è¿å¾™å®šå±…ã€å»ºé€ æˆ¿å±‹ã€ç»“å©šã€ç”Ÿå­ç­‰ï¼Œéƒ½ä¼šå…ˆå åœï¼Œçœ‹çœ‹å‰å‡¶ã€‚
  å¤ä»£å¸ç‹å’Œå°†å†›å¸¸åœ¨æˆ˜äº‰æˆ–å›½å®¶å¤§äº‹å‰è¯·åœå®˜å åœã€‚</li>
  <li>èŠ‚ä»¤èŠ‚æ°”æ—¶
  æœ‰äº›ç‰¹å®šèŠ‚æ—¥æˆ–èŠ‚æ°”ï¼Œç¥­ç¥€æ´»åŠ¨å¤šï¼Œé€šå¸¸ä¹Ÿä¼šå åœï¼Œç¥ˆæ±‚é£è°ƒé›¨é¡ºã€äº”è°·ä¸°ç™»ã€‚</li>
  <li>é‡åˆ°ç–‘éš¾äº‹æƒ…æˆ–ä¸é¡ºæ—¶
  é­é‡ç¾éš¾ã€ç–¾ç—…ã€å®¶åº­çŸ›ç›¾æ—¶ï¼Œæ°‘é—´ä¹Ÿä¼šæ±‚ç¥é—®åœï¼Œå¯»æ‰¾åŒ–è§£åŠæ³•ã€‚</li>
  <li>æ—¥å¸¸å°äº‹
  æœ‰äº›äººä¼šåœ¨å¹³å¸¸æ—¥å­é‡Œå åœï¼Œæ¯”å¦‚é—®é—®ä»Šå¤©æ˜¯å¦é€‚åˆå‡ºé—¨ã€åšæŸä»¶äº‹ã€‚</li>
</ol>

<h3 id="å åœæ–¹æ³•">å åœæ–¹æ³•</h3>
<p>æ°‘é—´å¹¿æ³›æµä¼ å„ç§å åœæ–¹æ³•ï¼Œå¦‚ï¼š</p>
<ul>
  <li>å…­çˆ»å åœ</li>
  <li>æ¢…èŠ±æ˜“æ•°</li>
  <li>å¥‡é—¨éç”²</li>
  <li>å¤ªä¹™ç¥æ•°</li>
  <li>å‘¨æ˜“å¦è±¡</li>
  <li>æ‰‹ç›¸ã€é¢ç›¸</li>
</ul>

<p><a href="https://tangyuewei.com/zhanbu/">æ¥ä¸€å¦å§</a></p>]]></content><author><name>tangyuewei</name></author><category term="å‘¨æ˜“" /><category term="å‘¨æ˜“" /><category term="å åœ" /><summary type="html"><![CDATA[å¤äººä¸€èˆ¬ä»€ä¹ˆæ—¶å€™å åœï¼Ÿ]]></summary></entry><entry><title type="html">ESæŸ¥è¯¢æ—¶ç´¢å¼•å»¶è¿Ÿæˆ–æ›´æ–°å¯¼è‡´æ•°æ®ä¸ä¸€è‡´</title><link href="https://tangyuewei.github.io/posts/ES%E6%9F%A5%E8%AF%A2%E6%97%B6%E7%B4%A2%E5%BC%95%E5%BB%B6%E8%BF%9F%E6%88%96%E6%9B%B4%E6%96%B0%E5%AF%BC%E8%87%B4%E6%95%B0%E6%8D%AE%E4%B8%8D%E4%B8%80%E8%87%B4/" rel="alternate" type="text/html" title="ESæŸ¥è¯¢æ—¶ç´¢å¼•å»¶è¿Ÿæˆ–æ›´æ–°å¯¼è‡´æ•°æ®ä¸ä¸€è‡´" /><published>2024-05-10T08:34:00+08:00</published><updated>2024-05-10T08:34:00+08:00</updated><id>https://tangyuewei.github.io/posts/ES%E6%9F%A5%E8%AF%A2%E6%97%B6%E7%B4%A2%E5%BC%95%E5%BB%B6%E8%BF%9F%E6%88%96%E6%9B%B4%E6%96%B0%E5%AF%BC%E8%87%B4%E6%95%B0%E6%8D%AE%E4%B8%8D%E4%B8%80%E8%87%B4</id><content type="html" xml:base="https://tangyuewei.github.io/posts/ES%E6%9F%A5%E8%AF%A2%E6%97%B6%E7%B4%A2%E5%BC%95%E5%BB%B6%E8%BF%9F%E6%88%96%E6%9B%B4%E6%96%B0%E5%AF%BC%E8%87%B4%E6%95%B0%E6%8D%AE%E4%B8%8D%E4%B8%80%E8%87%B4/"><![CDATA[<h1 id="esæŸ¥è¯¢æ—¶ç´¢å¼•å»¶è¿Ÿæˆ–æ›´æ–°å¯¼è‡´æ•°æ®ä¸ä¸€è‡´">ESæŸ¥è¯¢æ—¶ç´¢å¼•å»¶è¿Ÿæˆ–æ›´æ–°å¯¼è‡´æ•°æ®ä¸ä¸€è‡´</h1>

<blockquote>
  <p>å½“æ•°æ®æ›´æ–°æ¯”è¾ƒé¢‘ç¹æ—¶ï¼Œæˆ‘ä»¬çŸ­æ—¶é—´å†…ä½¿ç”¨ç›¸åŒçš„æŸ¥è¯¢æ¡ä»¶ï¼Œå¾—åˆ°çš„ç»“æœå’Œè®°å½•æ•°å´ä¸åŒã€‚å®é™…çš„ä¸šåŠ¡è¦æ±‚æŸ¥è¯¢çš„ç»“æœä¸€è‡´ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›è§£å†³åŠæ³•ã€‚</p>
</blockquote>

<p>é—®é¢˜å¯èƒ½æ˜¯ç”±äºElasticsearchçš„ç´¢å¼•å»¶è¿Ÿæˆ–æ›´æ–°é€ æˆçš„ã€‚å¯ä»¥è€ƒè™‘ä»¥ä¸‹æ­¥éª¤æ¥è§£å†³ï¼š</p>
<ol>
  <li>æ£€æŸ¥ç´¢å¼•åˆ·æ–°ç‡ï¼šç¡®ä¿ç´¢å¼•çš„åˆ·æ–°ç‡è®¾ç½®åˆç†ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒElasticsearchæ¯ç§’åˆ·æ–°ä¸€æ¬¡ï¼Œä½†æ ¹æ®éœ€è¦å¯èƒ½éœ€è¦è°ƒæ•´ã€‚</li>
  <li>ä½¿ç”¨<code class="language-plaintext highlighter-rouge">search_type=dfs_query_then_fetch</code>ï¼šè¿™ç¡®ä¿æŸ¥è¯¢ä½¿ç”¨å…¨å±€è¯é¢‘ï¼Œæœ‰åŠ©äºæé«˜ç»“æœçš„ä¸€è‡´æ€§ã€‚</li>
  <li>ä½¿ç”¨æ—¶é—´ç‚¹ï¼ˆPITï¼‰ï¼šä¸ºäº†åœ¨æŸ¥è¯¢ä¹‹é—´ä¿æŒç»“æœçš„ä¸€è‡´æ€§ï¼Œå¯ä»¥ä½¿ç”¨PITæ¥ä¿æŒç´¢å¼•çš„å¿«ç…§ã€‚</li>
  <li>æ£€æŸ¥ç´¢å¼•å¥åº·ï¼šç¡®ä¿æ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„ç´¢å¼•æ“ä½œæˆ–é—®é¢˜å½±å“æŸ¥è¯¢ç»“æœã€‚
æœ¬æ–‡è¯´ä¸‹2å’Œ3æ–¹æ¡ˆ
    <h2 id="ä½¿ç”¨-search_typedfs_query_then_fetch">ä½¿ç”¨ search_type=dfs_query_then_fetch</h2>
    <p><strong>è§£é‡Šï¼š</strong>
search_type=dfs_query_then_fetch æ˜¯ Elasticsearch çš„ä¸€ç§æœç´¢æ¨¡å¼ï¼Œç”¨äºæé«˜æŸ¥è¯¢çš„å‡†ç¡®æ€§ã€‚åœ¨é»˜è®¤çš„ query_then_fetch æ¨¡å¼ä¸­ï¼ŒæŸ¥è¯¢æ˜¯æŒ‰åˆ†ç‰‡è¿›è¡Œçš„ï¼Œæ¯ä¸ªåˆ†ç‰‡ç‹¬ç«‹è®¡ç®—æ–‡æ¡£é¢‘ç‡ï¼Œç„¶åå°†ç»“æœåˆå¹¶ã€‚ä½†è¿™å¯èƒ½ä¼šå¯¼è‡´åœ¨é¢‘ç¹æ›´æ–°çš„æƒ…å†µä¸‹ç»“æœçš„ä¸ä¸€è‡´ã€‚
dfs_query_then_fetch æ¨¡å¼é¦–å…ˆåœ¨æ‰€æœ‰åˆ†ç‰‡ä¸Šè®¡ç®—å…¨å±€è¯é¢‘ï¼ˆDocument Frequencyï¼‰ï¼Œç„¶åæ‰§è¡ŒæŸ¥è¯¢å’Œæ’åºã€‚è¿™ä½¿å¾—æŸ¥è¯¢å’Œæ’åºåŸºäºå…¨å±€çš„è¯é¢‘ä¿¡æ¯ï¼Œä»è€Œæä¾›æ›´ä¸€è‡´çš„æŸ¥è¯¢ç»“æœã€‚</p>
  </li>
</ol>

<p><strong>ä½¿ç”¨æ–¹æ³•ï¼š</strong>
åœ¨æŸ¥è¯¢è¯·æ±‚ä¸­ï¼Œä½ å¯ä»¥æ·»åŠ <code class="language-plaintext highlighter-rouge">search_type=dfs_query_then_fetch</code>å‚æ•°ã€‚ä¾‹å¦‚ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="rouge-code"><pre><span class="err">GET</span><span class="w"> </span><span class="err">/your_index/_search?search_type=dfs_query_then_fetch</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"bool"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"must"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"range"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"time"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"from"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-08-14 08:00:00"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"to"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-08-15 08:00:00"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"term"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"fileds1"</span><span class="p">:</span><span class="w"> </span><span class="s2">"xxx"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nl">"term"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"fileds2"</span><span class="p">:</span><span class="w"> </span><span class="s2">"xx"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
  </span><span class="nl">"aggs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"xsd_count"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"terms"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"fileds1"</span><span class="p">,</span><span class="w">  </span><span class="err">//æ ¹æ®fileds</span><span class="mi">1</span><span class="err">å»é‡æŸ¥è¯¢top</span><span class="mi">5</span><span class="w">
        </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"xsd_total"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"cardinality"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"fileds1"</span><span class="w"> </span><span class="err">//æ ¹æ®fileds</span><span class="mi">1</span><span class="err">å»é‡æŸ¥è¯¢æ€»æ•°</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>
<h2 id="ä½¿ç”¨æ—¶é—´ç‚¹pit">ä½¿ç”¨æ—¶é—´ç‚¹ï¼ˆPITï¼‰</h2>
<p><strong>è§£é‡Šï¼š</strong>
æ—¶é—´ç‚¹ï¼ˆPoint in Time, PITï¼‰æ˜¯ä¸€ç§åœ¨ Elasticsearch ä¸­è·å–ä¸€è‡´æŸ¥è¯¢ç»“æœçš„æœºåˆ¶ã€‚ä½¿ç”¨ PIT å¯ä»¥åœ¨ä¸€ä¸ªå›ºå®šçš„ç´¢å¼•å¿«ç…§ä¸Šæ‰§è¡Œå¤šä¸ªæŸ¥è¯¢ï¼Œç¡®ä¿æŸ¥è¯¢ç»“æœåœ¨æ•´ä¸ª PIT ç”Ÿå‘½å‘¨æœŸå†…çš„ä¸€è‡´æ€§ã€‚
PIT çš„ä¸»è¦ä¼˜ç‚¹æ˜¯å®ƒå…è®¸åœ¨ä¸€ä¸ªå›ºå®šçš„æ—¶é—´ç‚¹å¿«ç…§ä¸Šè¿›è¡Œå¤šæ¬¡æŸ¥è¯¢ï¼Œè¿™æ ·å³ä½¿ç´¢å¼•åœ¨æŸ¥è¯¢æœŸé—´å‘ç”Ÿäº†å˜åŒ–ï¼ŒæŸ¥è¯¢ç»“æœä¾ç„¶ä¼šä¿æŒä¸€è‡´ã€‚(æ•°æ®å¿«ç…§)</p>

<p><strong>ä½¿ç”¨æ–¹æ³•ï¼š</strong></p>
<ol>
  <li>
    <p>åˆ›å»º PIT
é¦–å…ˆï¼Œä½ éœ€è¦åˆ›å»ºä¸€ä¸ª PITã€‚å‘é€ä¸€ä¸ª POST è¯·æ±‚åˆ° _pit æ¥å£ä»¥åˆ›å»º PITï¼Œä¾‹å¦‚ï¼š
<code class="language-plaintext highlighter-rouge">POST /_pit?keep_alive=1m</code>
è¿™å°†è¿”å›ä¸€ä¸ª PIT IDï¼Œä½ å¯ä»¥åœ¨åç»­æŸ¥è¯¢ä¸­ä½¿ç”¨å®ƒã€‚</p>
  </li>
  <li>ä½¿ç”¨ PIT æ‰§è¡ŒæŸ¥è¯¢ï¼š
åœ¨æŸ¥è¯¢è¯·æ±‚ä¸­ï¼Œæ·»åŠ  pit å‚æ•°å’Œ PIT IDï¼Œä¾‹å¦‚ï¼š
    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="err">GET</span><span class="w"> </span><span class="err">/_search</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"pit"</span><span class="p">:{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"your_pit_id"</span><span class="p">,</span><span class="nl">"keep_alive"</span><span class="p">:</span><span class="s2">"1m"</span><span class="p">},</span><span class="w">
  </span><span class="nl">"query"</span><span class="p">:{</span><span class="w">
 </span><span class="nl">"bool"</span><span class="p">:{</span><span class="w">
     </span><span class="nl">"must"</span><span class="p">:[{</span><span class="w">
         </span><span class="nl">"range"</span><span class="p">:{</span><span class="nl">"time"</span><span class="p">:{</span><span class="nl">"from"</span><span class="p">:</span><span class="s2">"2024-08-14 08:00:00"</span><span class="p">,</span><span class="nl">"to"</span><span class="p">:</span><span class="s2">"2024-08-15 08:00:59"</span><span class="p">}}</span><span class="w">
             </span><span class="p">}]</span><span class="w">
         </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>å…³é—­ PITï¼š
æŸ¥è¯¢å®Œæˆåï¼Œä½ å¯ä»¥å…³é—­ PIT ä»¥é‡Šæ”¾èµ„æºï¼Œä¾‹å¦‚ï¼š
<code class="language-plaintext highlighter-rouge">DELETE /_pit?id=your_pit_id</code></li>
</ol>

<p>åœ¨PIT idé”™è¯¯ä¼šè¿”å›é”™è¯¯ï¼š</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"error"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"root_cause"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"illegal_argument_exception"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"reason"</span><span class="p">:</span><span class="w"> </span><span class="s2">"java.io.EOFException"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"illegal_argument_exception"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"reason"</span><span class="p">:</span><span class="w"> </span><span class="s2">"java.io.EOFException"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"caused_by"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"e_o_f_exception"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"reason"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">400</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>PIT idè¶…è¿‡æ—¶é—´è¿‡æœŸåè¿”å›é”™è¯¯ï¼š</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"error"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"root_cause"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
                </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"search_context_missing_exception"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"reason"</span><span class="p">:</span><span class="w"> </span><span class="s2">"No search context found for id [4635252]"</span><span class="w">
        </span><span class="p">}],</span><span class="w">
    </span><span class="nl">"phase"</span><span class="p">:</span><span class="w"> </span><span class="s2">"query"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"grouped"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"failed_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"shard"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="nl">"index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"index-2022"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"node"</span><span class="p">:</span><span class="w"> </span><span class="s2">"4sIEuxxxxxxxxxx"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"reason"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"search_context_missing_exception"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"reason"</span><span class="p">:</span><span class="w"> </span><span class="s2">"No search context found for id [12345678]"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}],</span><span class="w">
    </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">404</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>]]></content><author><name>tangyuewei</name></author><category term="å¸¸ç”¨æ¡†æ¶" /><category term="Elasticsearch" /><category term="ES" /><summary type="html"><![CDATA[ESæŸ¥è¯¢æ—¶ç´¢å¼•å»¶è¿Ÿæˆ–æ›´æ–°å¯¼è‡´æ•°æ®ä¸ä¸€è‡´]]></summary></entry><entry><title type="html">æ·±å…¥æµ…å‡º Netty</title><link href="https://tangyuewei.github.io/posts/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA-Netty/" rel="alternate" type="text/html" title="æ·±å…¥æµ…å‡º Netty" /><published>2024-04-22T16:34:00+08:00</published><updated>2024-04-22T16:34:00+08:00</updated><id>https://tangyuewei.github.io/posts/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%20Netty</id><content type="html" xml:base="https://tangyuewei.github.io/posts/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA-Netty/"><![CDATA[<h1 id="nettyjava-é«˜æ€§èƒ½ç½‘ç»œç¼–ç¨‹æ¡†æ¶">Nettyï¼šJava é«˜æ€§èƒ½ç½‘ç»œç¼–ç¨‹æ¡†æ¶</h1>

<h2 id="1-å¼•è¨€">1. å¼•è¨€</h2>

<p>Netty æ˜¯ä¸€ä¸ªåŸºäº Java çš„é«˜æ€§èƒ½ç½‘ç»œç¼–ç¨‹æ¡†æ¶ï¼Œå¹¿æ³›åº”ç”¨äºé«˜å¹¶å‘ã€å¤§è§„æ¨¡çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ã€‚å®ƒæä¾›äº†å¼‚æ­¥äº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨æ¡†æ¶å’Œå·¥å…·ï¼Œç®€åŒ–äº†ç½‘ç»œç¼–ç¨‹çš„å¤æ‚æ€§ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç» Netty çš„æ ¸å¿ƒæ¦‚å¿µã€å…³é”®ç»„ä»¶å’ŒåŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿä¸Šæ‰‹å¹¶æŒæ¡è¿™é—¨æŠ€æœ¯ã€‚</p>

<h2 id="2-netty-çš„æ ¸å¿ƒæ¦‚å¿µ">2. Netty çš„æ ¸å¿ƒæ¦‚å¿µ</h2>

<h3 id="21-channel">2.1 Channel</h3>

<p><code class="language-plaintext highlighter-rouge">Channel</code> æ˜¯ Netty æ•°æ®ä¼ è¾“çš„åŸºæœ¬æŠ½è±¡ï¼Œå®ƒä»£è¡¨ä¸€ä¸ªæ‰“å¼€çš„è¿æ¥ï¼ˆå¯ä»¥æ˜¯ TCP è¿æ¥ã€UDP è¿æ¥æˆ–æ–‡ä»¶ï¼‰ã€‚å®ƒæä¾›äº†å¼‚æ­¥çš„è¯»å†™æ“ä½œï¼Œå¹¶ä¸”è¿™äº›æ“ä½œéƒ½è¿”å› <code class="language-plaintext highlighter-rouge">ChannelFuture</code> å¯¹è±¡ï¼Œç”¨äºåœ¨æ“ä½œå®Œæˆæ—¶é€šçŸ¥åº”ç”¨ç¨‹åºã€‚</p>

<h3 id="22-eventloop">2.2 EventLoop</h3>

<p><code class="language-plaintext highlighter-rouge">EventLoop</code> æ˜¯ä¸€ä¸ªå¤„ç† I/O æ“ä½œçš„å¾ªç¯ã€‚æ¯ä¸ª <code class="language-plaintext highlighter-rouge">Channel</code> éƒ½ä¼šç»‘å®šä¸€ä¸ª <code class="language-plaintext highlighter-rouge">EventLoop</code>ï¼Œè´Ÿè´£å¤„ç†è¯¥ <code class="language-plaintext highlighter-rouge">Channel</code> çš„æ‰€æœ‰äº‹ä»¶ã€‚<code class="language-plaintext highlighter-rouge">EventLoop</code> è´Ÿè´£ç®¡ç†ä¸€ä¸ªæˆ–å¤šä¸ª <code class="language-plaintext highlighter-rouge">Channel</code> çš„ I/O æ“ä½œã€‚</p>

<h3 id="23-channelhandler">2.3 ChannelHandler</h3>

<p><code class="language-plaintext highlighter-rouge">ChannelHandler</code> æ˜¯å¤„ç† I/O äº‹ä»¶æˆ–æ‹¦æˆª I/O æ“ä½œçš„æ ¸å¿ƒæ¥å£ã€‚å®ƒåŒ…æ‹¬ä¸¤ç±»ä¸»è¦å®ç°ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ChannelInboundHandler</code>ï¼šå¤„ç†å…¥ç«™ I/O äº‹ä»¶ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">ChannelOutboundHandler</code>ï¼šå¤„ç†å‡ºç«™ I/O æ“ä½œã€‚</li>
</ul>

<h3 id="24-channelpipeline">2.4 ChannelPipeline</h3>

<p><code class="language-plaintext highlighter-rouge">ChannelPipeline</code> æ˜¯ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">ChannelHandler</code> é“¾ï¼Œç”¨äºæ‹¦æˆªå’Œå¤„ç†æ‰€æœ‰çš„ I/O äº‹ä»¶ã€‚æ¯ä¸ª <code class="language-plaintext highlighter-rouge">Channel</code> éƒ½æœ‰ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">ChannelPipeline</code>ï¼Œå®ƒè´Ÿè´£ç®¡ç†å’Œè°ƒç”¨ <code class="language-plaintext highlighter-rouge">ChannelHandler</code> é“¾ä¸­çš„å„ä¸ªå¤„ç†å™¨ã€‚</p>

<h2 id="3-netty-çš„å…³é”®ç»„ä»¶">3. Netty çš„å…³é”®ç»„ä»¶</h2>

<h3 id="31-bootstrap-å’Œ-serverbootstrap">3.1 Bootstrap å’Œ ServerBootstrap</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Bootstrap</code>ï¼šç”¨äºå¼•å¯¼å®¢æˆ·ç«¯ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">ServerBootstrap</code>ï¼šç”¨äºå¼•å¯¼æœåŠ¡å™¨ã€‚</li>
</ul>

<p>å®ƒä»¬è´Ÿè´£é…ç½® <code class="language-plaintext highlighter-rouge">Channel</code> å’Œå…¶ä»–ç›¸å…³å‚æ•°ã€‚</p>

<h3 id="32-nioeventloopgroup">3.2 NioEventLoopGroup</h3>

<p><code class="language-plaintext highlighter-rouge">NioEventLoopGroup</code> æ˜¯ <code class="language-plaintext highlighter-rouge">EventLoopGroup</code> çš„å®ç°ï¼Œç”¨äºå¤„ç† I/O æ“ä½œã€‚å®ƒåŒ…å«ä¸€ç»„ <code class="language-plaintext highlighter-rouge">NioEventLoop</code>ï¼Œæ¯ä¸ª <code class="language-plaintext highlighter-rouge">NioEventLoop</code> åœ¨ç‹¬ç«‹çš„çº¿ç¨‹ä¸­è¿è¡Œã€‚</p>

<h2 id="4-netty-çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•">4. Netty çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•</h2>

<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ Netty æœåŠ¡å™¨ç¤ºä¾‹ä»£ç ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelOption</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.EventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.string.StringDecoder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.string.StringEncoder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.logging.LogLevel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.logging.LoggingHandler</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyServer</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">port</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">NettyServer</span><span class="o">(</span><span class="kt">int</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">port</span> <span class="o">=</span> <span class="n">port</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">EventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="nc">EventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">ServerBootstrap</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">();</span>
            <span class="n">b</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
             <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
             <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="nc">ChannelOption</span><span class="o">.</span><span class="na">SO_BACKLOG</span><span class="o">,</span> <span class="mi">100</span><span class="o">)</span>
             <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="na">INFO</span><span class="o">))</span>
             <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                 <span class="nd">@Override</span>
                 <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
                     <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringDecoder</span><span class="o">());</span>
                     <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringEncoder</span><span class="o">());</span>
                     <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleChannelHandler</span><span class="o">());</span>
                 <span class="o">}</span>
             <span class="o">});</span>

            <span class="nc">ChannelFuture</span> <span class="n">f</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">port</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
            <span class="n">f</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
            <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="k">new</span> <span class="nf">NettyServer</span><span class="o">(</span><span class="mi">8080</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">SimpleChannelHandler</span> <span class="kd">extends</span> <span class="n">io</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">channel</span><span class="o">.</span><span class="na">ChannelInboundHandlerAdapter</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">io</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">channel</span><span class="o">.</span><span class="na">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">message</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Received message: "</span> <span class="o">+</span> <span class="n">message</span><span class="o">);</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="s">"Echo: "</span> <span class="o">+</span> <span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">io</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">channel</span><span class="o">.</span><span class="na">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">cause</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="5-ç»“è®º">5. ç»“è®º</h2>

<p>Netty ä½œä¸ºä¸€ä¸ªå¼ºå¤§çš„å¼‚æ­¥äº‹ä»¶é©±åŠ¨çš„ç½‘ç»œæ¡†æ¶ï¼Œç®€åŒ–äº† Java ç½‘ç»œç¼–ç¨‹çš„å¤æ‚æ€§ï¼Œæé«˜äº†å¼€å‘æ•ˆç‡ã€‚é€šè¿‡ç†è§£å…¶æ ¸å¿ƒæ¦‚å¿µå’Œå…³é”®ç»„ä»¶ï¼Œå¼€å‘è€…å¯ä»¥æ„å»ºé«˜æ€§èƒ½çš„ç½‘ç»œåº”ç”¨ç¨‹åºã€‚å¸Œæœ›æœ¬æ–‡å¯¹æ‚¨äº†è§£å’Œä½¿ç”¨ Netty æœ‰æ‰€å¸®åŠ©ã€‚</p>

<p>å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºç•™è¨€è®¨è®ºã€‚Happy Coding!</p>]]></content><author><name>tangyuewei</name></author><category term="å¸¸ç”¨æ¡†æ¶" /><category term="Netty" /><summary type="html"><![CDATA[Nettyï¼šJava é«˜æ€§èƒ½ç½‘ç»œç¼–ç¨‹æ¡†æ¶]]></summary></entry><entry><title type="html">Netty å­¦ä¹ ä¸ä½¿ç”¨</title><link href="https://tangyuewei.github.io/posts/Netty%E5%AD%A6%E4%B9%A0%E4%B8%8E%E4%BD%BF%E7%94%A8/" rel="alternate" type="text/html" title="Netty å­¦ä¹ ä¸ä½¿ç”¨" /><published>2024-04-19T11:20:00+08:00</published><updated>2024-04-19T11:20:00+08:00</updated><id>https://tangyuewei.github.io/posts/Netty%E5%AD%A6%E4%B9%A0%E4%B8%8E%E4%BD%BF%E7%94%A8</id><content type="html" xml:base="https://tangyuewei.github.io/posts/Netty%E5%AD%A6%E4%B9%A0%E4%B8%8E%E4%BD%BF%E7%94%A8/"><![CDATA[<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<blockquote>
  <p><code class="language-plaintext highlighter-rouge">netty</code>æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„<code class="language-plaintext highlighter-rouge">socket</code>æ¡†æ¶ã€‚</p>
</blockquote>

<h2 id="æºç ">æºç </h2>

<blockquote>
  <p>https://github.com/netty/netty</p>
</blockquote>

<h2 id="å¿«é€Ÿå…¥é—¨">å¿«é€Ÿå…¥é—¨</h2>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre>    <span class="nt">&lt;build&gt;</span>
        <span class="nt">&lt;plugins&gt;</span>
            <span class="c">&lt;!--ã€å¿…ç”¨æ’ä»¶ã€‘ç”¨äºè®¾ç½®é¡¹ç›®jdkç‰ˆæœ¬--&gt;</span>
            <span class="nt">&lt;plugin&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>3.8.1<span class="nt">&lt;/version&gt;</span>
                <span class="nt">&lt;configuration&gt;</span>
                    <span class="nt">&lt;source&gt;</span>8<span class="nt">&lt;/source&gt;</span>
                    <span class="nt">&lt;target&gt;</span>8<span class="nt">&lt;/target&gt;</span>
                    <span class="nt">&lt;encoding&gt;</span>UTF-8<span class="nt">&lt;/encoding&gt;</span>
                <span class="nt">&lt;/configuration&gt;</span>
            <span class="nt">&lt;/plugin&gt;</span>
        <span class="nt">&lt;/plugins&gt;</span>
    <span class="nt">&lt;/build&gt;</span>


    <span class="nt">&lt;dependencies&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>io.netty<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>netty-all<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>4.1.20.Final<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.google.protobuf<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>protobuf-java<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>3.2.0<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="å®¢æˆ·ç«¯">å®¢æˆ·ç«¯</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">connect</span><span class="o">(</span><span class="nc">String</span> <span class="n">ip</span><span class="o">,</span> <span class="kt">int</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">NioEventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">();</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">workerGroup</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="nc">ChannelOption</span><span class="o">.</span><span class="na">SO_KEEPALIVE</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                        <span class="nd">@Override</span>
                        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">socketChannel</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                            <span class="nc">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">socketChannel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
                            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">"intDecoder"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ProtobufVarint32FrameDecoder</span><span class="o">());</span>
                            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">"intEncoder"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ProtobufVarint32LengthFieldPrepender</span><span class="o">());</span>
                            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">"protobufDecoder"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ProtobufDecoder</span><span class="o">(</span><span class="nc">MessagePOJO</span><span class="o">.</span><span class="na">Message</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">()));</span>
                            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">"protobufEncoder"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ProtobufEncoder</span><span class="o">());</span>
                            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleClientHandler</span><span class="o">());</span>
                        <span class="o">}</span>
                    <span class="o">});</span>
            <span class="nc">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">ip</span><span class="o">,</span> <span class="n">port</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">channelFuture</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">())</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"è¿æ¥æˆåŠŸï¼ï¼ï¼ï¼"</span><span class="o">);</span>
            <span class="k">else</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"è¿æ¥å¤±è´¥"</span><span class="o">);</span>
            <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>â€”â€”â€”-å¦ä¸€ç§â€”â€”â€”â€”â€”â€”â€”â€“</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">connect</span><span class="o">(</span><span class="nc">String</span> <span class="n">ip</span><span class="o">,</span> <span class="kt">int</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">EventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span><span class="c1">// å¼€å¯å·¥ä½œçº¿ç¨‹ç»„</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">();</span> <span class="c1">//åˆ›å»ºä¸€ä¸ªå’ŒæœåŠ¡ç«¯ç›¸å¯¹åº”çš„server</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">)</span> <span class="c1">//è®¾ç½®çº¿ç¨‹ç»„</span>
                    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">//ä½¿ç”¨NioSocketChannelä½œä¸ºå®¢æˆ·ç«¯çš„é€šé“å®ç°</span>
                    <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span><span class="c1">//è®¾ç½®å›è°ƒå‡½æ•°</span>
                        <span class="nd">@Override</span>
                        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">NettyClientHandler</span><span class="o">());</span>
                        <span class="o">}</span>
                    <span class="o">});</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"netty client startã€‚ã€‚"</span><span class="o">);</span>
            <span class="nc">ChannelFuture</span> <span class="n">cf</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">9000</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span><span class="c1">//å¯åŠ¨å®¢æˆ·ç«¯å»è¿æ¥æœåŠ¡å™¨ç«¯</span>
            <span class="c1">//å¯¹é€šé“å…³é—­è¿›è¡Œç›‘å¬</span>
            <span class="n">cf</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">group</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span><span class="c1">//å…³é—­çº¿ç¨‹ç»„</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<h3 id="æœåŠ¡ç«¯">æœåŠ¡ç«¯</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">startServer</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">NioEventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
        <span class="nc">NioEventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">ServerBootstrap</span> <span class="n">serverBootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">();</span>
            <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="nc">ChannelOption</span><span class="o">.</span><span class="na">SO_BACKLOG</span><span class="o">,</span> <span class="mi">128</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">childOption</span><span class="o">(</span><span class="nc">ChannelOption</span><span class="o">.</span><span class="na">SO_KEEPALIVE</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                        <span class="nd">@Override</span>
                        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">socketChannel</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                            <span class="nc">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">socketChannel</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
                            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">"intDecoder"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ProtobufVarint32FrameDecoder</span><span class="o">());</span>
                            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">"intEncoder"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ProtobufVarint32LengthFieldPrepender</span><span class="o">());</span>
                            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">"protobufDecoder"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ProtobufDecoder</span><span class="o">(</span><span class="nc">MessagePOJO</span><span class="o">.</span><span class="na">Message</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">()));</span>
                            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleServerHandler</span><span class="o">());</span>
                        <span class="o">}</span>
                    <span class="o">});</span>
            <span class="nc">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">port</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">channelFuture</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">())</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æœåŠ¡å™¨å¼€å¯æˆåŠŸï¼ï¼ï¼ï¼"</span><span class="o">);</span>
            <span class="k">else</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æœåŠ¡å™¨å¼€å¯å¤±è´¥"</span><span class="o">);</span>
            <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
            <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>
<p>â€”â€”â€”-å¦ä¸€ç§â€”â€”â€”â€”â€”â€”â€”â€“</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">startServer</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">EventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span><span class="c1">//æ–°å»ºçº¿ç¨‹ç»„,ç”¨äºå¤„ç†è¯·æ±‚</span>
        <span class="nc">EventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span><span class="c1">//çœŸæ­£å·¥ä½œçš„çº¿ç¨‹ç»„</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">ServerBootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">();</span><span class="c1">//åˆ›å»ºä¸€ä¸ªserver,ç›¸å½“äºNIOçš„server</span>
            <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span> <span class="c1">//é‡‡ç”¨é“¾å¼ç¼–ç¨‹,å°†ä¸¤ä¸ªçº¿ç¨‹ç»„åŠ å…¥åˆ°serverä¸­</span>
                    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">//è®¾ç½®ä¸€ä¸ªä¿¡é“,ç›¸å½“äºNIOä¸­çš„ServerSocketChannel</span>
                    <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="nc">ChannelOption</span><span class="o">.</span><span class="na">SO_BACKLOG</span><span class="o">,</span> <span class="mi">1024</span><span class="o">)</span> <span class="c1">//å¯¹æœåŠ¡ç«¯ç»™äºˆä¸€äº›è®¾ç½®</span>
                    <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span><span class="c1">//ç»™äºˆåˆå§‹åŒ–,å¹¶åŠ å…¥å›è°ƒå‡½æ•°</span>
                        <span class="nd">@Override</span>
                        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">NettyServerHandler</span><span class="o">());</span>
                        <span class="o">}</span>
                    <span class="o">});</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"netty server startã€‚ã€‚"</span><span class="o">);</span>
            <span class="nc">ChannelFuture</span> <span class="n">cf</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">9000</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span><span class="c1">//ç»‘å®šç«¯å£,syncæ–¹æ³•æ˜¯ç­‰å¾…å¼‚æ­¥æ“ä½œæ‰§è¡Œå®Œæ¯•</span>
            <span class="n">cf</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span><span class="c1">//å¯¹é€šé“å…³é—­è¿›è¡Œç›‘å¬ï¼ŒcloseFutureæ˜¯å¼‚æ­¥æ“ä½œï¼Œç›‘å¬é€šé“å…³é—­</span>
                                        <span class="c1">// é€šè¿‡syncæ–¹æ³•åŒæ­¥ç­‰å¾…é€šé“å…³é—­å¤„ç†å®Œæ¯•ï¼Œè¿™é‡Œä¼šé˜»å¡ç­‰å¾…é€šé“å…³é—­å®Œæˆ</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span> <span class="c1">//å…³é—­å¤„ç†è¯·æ±‚çš„çº¿ç¨‹ç»„</span>
            <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span><span class="c1">//å…³é—­çœŸæ­£å·¥ä½œçš„çº¿ç¨‹ç»„</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å›è°ƒ">å›è°ƒ</h2>

<h3 id="æœåŠ¡ç«¯å›è°ƒ">æœåŠ¡ç«¯å›è°ƒ</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyServerHandler</span> <span class="kd">extends</span> <span class="nc">ChannelInboundHandlerAdapter</span> <span class="o">{</span>

    <span class="c1">//å½“å®¢æˆ·ç«¯è¿æ¥æœåŠ¡å™¨å®Œæˆå°±ä¼šè§¦å‘è¯¥æ–¹æ³•</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="nc">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">(</span><span class="s">"HelloServer"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="nc">CharsetUtil</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//å½“é€šé“æœ‰è¯»å–äº‹ä»¶æ—¶ä¼šè§¦å‘ï¼Œå³å®¢æˆ·ç«¯å‘é€æ•°æ®ç»™æœåŠ¡ç«¯</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ”¶åˆ°å®¢æˆ·ç«¯çš„æ¶ˆæ¯:"</span> <span class="o">+</span> <span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="nc">CharsetUtil</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å®¢æˆ·ç«¯çš„åœ°å€ï¼š "</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">remoteAddress</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æˆ‘æ”¶åˆ°äº†å¼‚å¸¸"</span><span class="o">);</span>
        <span class="n">cause</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<h3 id="å®¢æˆ·ç«¯å›è°ƒ">å®¢æˆ·ç«¯å›è°ƒ</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyClientHandler</span> <span class="kd">extends</span> <span class="nc">ChannelInboundHandlerAdapter</span> <span class="o">{</span>

    <span class="cm">/**
     * å½“å®¢æˆ·ç«¯è¿æ¥æœåŠ¡å™¨å®Œæˆå°±ä¼šè§¦å‘è¯¥æ–¹æ³•
     *
     * @param ctx è®¾ç½®å¥½çš„ä¿¡é“,ç›¸å½“äºä¸Šä¸‹æ–‡
     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="nc">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">(</span><span class="s">"HelloServer"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="nc">CharsetUtil</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//å½“é€šé“æœ‰è¯»å–äº‹ä»¶æ—¶ä¼šè§¦å‘ï¼Œå³æœåŠ¡ç«¯å‘é€æ•°æ®ç»™å®¢æˆ·ç«¯</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ”¶åˆ°æœåŠ¡ç«¯çš„æ¶ˆæ¯:"</span> <span class="o">+</span> <span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="nc">CharsetUtil</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æœåŠ¡ç«¯çš„åœ°å€ï¼š "</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">remoteAddress</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">cause</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å‚è€ƒæ–‡æ¡£">å‚è€ƒæ–‡æ¡£</h2>

<ul>
  <li><a href="https://waylau.com/netty-4-user-guide/">Netty 4.x ç”¨æˆ·æŒ‡å—</a></li>
  <li><a href="http://www.pingtaimeng.com/article/detail/id/504963">Netty èŠå¤©å®¤</a></li>
  <li><a href="https://github.com/code4craft/netty-learning/blob/master/posts/ch1-overview.md">netty-learning</a></li>
</ul>]]></content><author><name>tangyuewei</name></author><category term="å¸¸ç”¨æ¡†æ¶" /><category term="Netty" /><summary type="html"><![CDATA[æ¦‚è¿° nettyæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„socketæ¡†æ¶ã€‚]]></summary></entry><entry><title type="html">ä»vuepressè¿ç§»è‡³jekyll</title><link href="https://tangyuewei.github.io/posts/%E4%BB%8Evuepress%E8%BF%81%E7%A7%BB%E8%87%B3jekyll/" rel="alternate" type="text/html" title="ä»vuepressè¿ç§»è‡³jekyll" /><published>2023-12-29T14:00:00+08:00</published><updated>2023-12-29T14:00:00+08:00</updated><id>https://tangyuewei.github.io/posts/%E4%BB%8Evuepress%E8%BF%81%E7%A7%BB%E8%87%B3jekyll</id><content type="html" xml:base="https://tangyuewei.github.io/posts/%E4%BB%8Evuepress%E8%BF%81%E7%A7%BB%E8%87%B3jekyll/"><![CDATA[<h2 id="ä»vuepressè¿ç§»è‡³jekyll">ä»vuepressè¿ç§»è‡³jekyll</h2>

<blockquote>
  <p>åšè¿‡æŠ€æœ¯å¼€å‘çš„éƒ½çŸ¥é“ï¼Œè¿ç§»æ˜¯ä¸€ä»¶å¾ˆç—›è‹¦çš„äº‹æƒ…ï¼Œäº²èº«ä½“éªŒè¿‡æ‰çŸ¥é“ï¼Œä½†æ˜¯ç—›è‹¦çš„è¿‡ç¨‹æ˜¯æœ‰æ”¶è·çš„ã€‚ èµ·åˆä½¿ç”¨<code class="language-plaintext highlighter-rouge">vuepress</code>æ¥å†™åšå®¢ï¼Œæ„Ÿè§‰è¿˜æŒºé«˜å¤§ä¸Šï¼Œæœ‰ç›®å½•å±‚çº§æœºæ„ã€‚ä½†æ˜¯åæ¥å‘ç°ï¼Œç”¨ä»–æ¥äº›åšå®¢å¹¶ä¸å¥½ï¼Œå†™æ–‡æ¡£æ¯”è¾ƒåˆé€‚ï¼Œè€Œä¸”ä¸æ”¯æŒä¸€äº›åŠŸèƒ½ï¼Œæ¯”å¦‚è¯´è¯„è®ºï¼Œè€Œä¸”å®ƒçš„ä¸»é¢˜ä¹Ÿä¸å¥½çœ‹ï¼Œæ‰€ä»¥å°±å†³å®šè¿ç§»åˆ°<code class="language-plaintext highlighter-rouge">jekyll</code>ã€‚</p>
</blockquote>

<p>é™„ä¸¤å¼ å›¾çºªå¿µï¼š</p>
<ul>
  <li>é¦–é¡µ
<img title="é¦–é¡µ" src="/assets/img/20231229135327.png" /></li>
  <li>è¯¦æƒ…é¡µ
<img title="è¯¦æƒ…é¡µ" src="/assets/img/20231229135459.png" /></li>
</ul>

<p>å…ƒæ—¦å¿«ä¹ï¼</p>]]></content><author><name>tangyuewei</name></author><category term="åšå®¢é‚£äº›äº‹" /><category term="åšå®¢è¿ç§»" /><category term="vuepress" /><category term="jekyll" /><summary type="html"><![CDATA[ä»vuepressè¿ç§»è‡³jekyll]]></summary></entry><entry><title type="html">Spring Security oAuth2åº”ç”¨</title><link href="https://tangyuewei.github.io/posts/Spring-Security-oAuth2%E5%BA%94%E7%94%A8/" rel="alternate" type="text/html" title="Spring Security oAuth2åº”ç”¨" /><published>2023-03-12T16:15:00+08:00</published><updated>2023-03-12T16:15:00+08:00</updated><id>https://tangyuewei.github.io/posts/Spring%20Security%20oAuth2%E5%BA%94%E7%94%A8</id><content type="html" xml:base="https://tangyuewei.github.io/posts/Spring-Security-oAuth2%E5%BA%94%E7%94%A8/"><![CDATA[<h2 id="æ•°æ®è¡¨">æ•°æ®è¡¨</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre></td><td class="rouge-code"><pre>CREATE TABLE `clientdetails` (
  `appId` varchar(128) NOT NULL,
  `resourceIds` varchar(256) DEFAULT NULL,
  `appSecret` varchar(256) DEFAULT NULL,
  `scope` varchar(256) DEFAULT NULL,
  `grantTypes` varchar(256) DEFAULT NULL,
  `redirectUrl` varchar(256) DEFAULT NULL,
  `authorities` varchar(256) DEFAULT NULL,
  `access_token_validity` int(11) DEFAULT NULL,
  `refresh_token_validity` int(11) DEFAULT NULL,
  `additionalInformation` varchar(4096) DEFAULT NULL,
  `autoApproveScopes` varchar(256) DEFAULT NULL,
  PRIMARY KEY (`appId`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `oauth_access_token` (
  `token_id` varchar(256) DEFAULT NULL,
  `token` blob,
  `authentication_id` varchar(128) NOT NULL,
  `user_name` varchar(256) DEFAULT NULL,
  `client_id` varchar(256) DEFAULT NULL,
  `authentication` blob,
  `refresh_token` varchar(256) DEFAULT NULL,
  PRIMARY KEY (`authentication_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `oauth_approvals` (
  `userId` varchar(256) DEFAULT NULL,
  `clientId` varchar(256) DEFAULT NULL,
  `scope` varchar(256) DEFAULT NULL,
  `status` varchar(10) DEFAULT NULL,
  `expiresAt` timestamp NULL DEFAULT NULL,
  `lastModifiedAt` timestamp NULL DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `oauth_client_details` (
  `client_id` varchar(128) NOT NULL,
  `resource_ids` varchar(256) DEFAULT NULL,
  `client_secret` varchar(256) DEFAULT NULL,
  `scope` varchar(256) DEFAULT NULL,
  `authorized_grant_types` varchar(256) DEFAULT NULL,
  `web_server_redirect_uri` varchar(256) DEFAULT NULL,
  `authorities` varchar(256) DEFAULT NULL,
  `access_token_validity` int(11) DEFAULT NULL,
  `refresh_token_validity` int(11) DEFAULT NULL,
  `additional_information` varchar(4096) DEFAULT NULL,
  `autoapprove` varchar(256) DEFAULT NULL,
  PRIMARY KEY (`client_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `oauth_client_token` (
  `token_id` varchar(256) DEFAULT NULL,
  `token` blob,
  `authentication_id` varchar(128) NOT NULL,
  `user_name` varchar(256) DEFAULT NULL,
  `client_id` varchar(256) DEFAULT NULL,
  PRIMARY KEY (`authentication_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `oauth_code` (
  `code` varchar(256) DEFAULT NULL,
  `authentication` blob
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `oauth_refresh_token` (
  `token_id` varchar(256) DEFAULT NULL,
  `token` blob,
  `authentication` blob
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å¼•å…¥ä¾èµ–">å¼•å…¥ä¾èµ–</h2>

<h3 id="pomxml">pom.xml</h3>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">"http://maven.apache.org/POM/4.0.0"</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.qjdmy<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>qjdmy-parent<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0.0.RELEASE<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>qjdmy-oauth<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.0.1-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;packaging&gt;</span>jar<span class="nt">&lt;/packaging&gt;</span>
    <span class="nt">&lt;url&gt;</span>http://www.qjdmy.com<span class="nt">&lt;/url&gt;</span>
    <span class="nt">&lt;inceptionYear&gt;</span>2020-Now<span class="nt">&lt;/inceptionYear&gt;</span>
    <span class="nt">&lt;description&gt;</span>è®¤è¯ä¸æˆæƒ<span class="nt">&lt;/description&gt;</span>

    <span class="nt">&lt;scm&gt;</span>
        <span class="nt">&lt;connection&gt;</span>scm:git:http://gitlab.tangyuewei.com/qjdmy/qjdmy-oauth.git<span class="nt">&lt;/connection&gt;</span>
        <span class="nt">&lt;developerConnection&gt;</span>scm:git:http://gitlab.tangyuewei.com/qjdmy/qjdmy-oauth.git<span class="nt">&lt;/developerConnection&gt;</span>
        <span class="nt">&lt;url&gt;</span>http://gitlab.tangyuewei.com/qjdmy/qjdmy-oauth<span class="nt">&lt;/url&gt;</span>
        <span class="nt">&lt;tag&gt;</span>HEAD<span class="nt">&lt;/tag&gt;</span>
    <span class="nt">&lt;/scm&gt;</span>

    <span class="nt">&lt;developers&gt;</span>
        <span class="nt">&lt;developer&gt;</span>
            <span class="nt">&lt;id&gt;</span>tangyuewei<span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;name&gt;</span>Webster Tang<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;email&gt;</span>472680811@qq.com<span class="nt">&lt;/email&gt;</span>
        <span class="nt">&lt;/developer&gt;</span>
    <span class="nt">&lt;/developers&gt;</span>

    <span class="nt">&lt;dependencies&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>


        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-oauth2<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>


        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>javax.servlet<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>javax.servlet-api<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>


        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>


        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>${project.groupId}<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>qfdmy-repository-core<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${project.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>${project.groupId}<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>qfdmy-commons<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${project.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>

    <span class="nt">&lt;profiles&gt;</span>
        <span class="nt">&lt;profile&gt;</span>
            <span class="nt">&lt;id&gt;</span>microservice<span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;build&gt;</span>
                <span class="nt">&lt;plugins&gt;</span>
                    <span class="nt">&lt;plugin&gt;</span>
                        <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
                        <span class="nt">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
                        <span class="nt">&lt;configuration&gt;</span>
                            <span class="nt">&lt;mainClass&gt;</span>com.qjdmy.oauth.AuthApplication<span class="nt">&lt;/mainClass&gt;</span>
                        <span class="nt">&lt;/configuration&gt;</span>
                    <span class="nt">&lt;/plugin&gt;</span>
                <span class="nt">&lt;/plugins&gt;</span>
            <span class="nt">&lt;/build&gt;</span>
        <span class="nt">&lt;/profile&gt;</span>
    <span class="nt">&lt;/profiles&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="applicationyml">application.yml</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="na">server</span><span class="pi">:</span>
  <span class="na">port</span><span class="pi">:</span> <span class="m">9090</span>

<span class="na">spring</span><span class="pi">:</span>
  <span class="na">application</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">qjdmy-oauth</span>
  <span class="na">main</span><span class="pi">:</span>
    <span class="na">allow-bean-definition-overriding</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">datasource</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">com.zaxxer.hikari.HikariDataSource</span>
    <span class="na">driver-class-name</span><span class="pi">:</span> <span class="s">com.mysql.cj.jdbc.Driver</span>
    <span class="na">jdbc-url</span><span class="pi">:</span> <span class="s">jdbc:mysql://mysql.tangyuewei.com:3306/qfdmy?serverTimezone=Asia/Shanghai&amp;useLegacyDatetimeCode=false&amp;nullNamePatternMatchesAll=true&amp;zeroDateTimeBehavior=CONVERT_TO_NULL&amp;tinyInt1isBit=false&amp;autoReconnect=true&amp;useSSL=false&amp;pinGlobalTxToPhysicalConnection=true</span>
    <span class="na">username</span><span class="pi">:</span> <span class="s">root</span>
    <span class="na">password</span><span class="pi">:</span> <span class="m">123456</span>
    <span class="na">hikari</span><span class="pi">:</span>
      <span class="na">minimum-idle</span><span class="pi">:</span> <span class="m">5</span>
      <span class="na">idle-timeout</span><span class="pi">:</span> <span class="m">600000</span>
      <span class="na">maximum-pool-size</span><span class="pi">:</span> <span class="m">10</span>
      <span class="na">auto-commit</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">pool-name</span><span class="pi">:</span> <span class="s">MyHikariCP</span>
      <span class="na">max-lifetime</span><span class="pi">:</span> <span class="m">1800000</span>
      <span class="na">connection-timeout</span><span class="pi">:</span> <span class="m">30000</span>
      <span class="na">connection-test-query</span><span class="pi">:</span> <span class="s">SELECT </span><span class="m">1</span>

<span class="na">security</span><span class="pi">:</span>
  <span class="na">oauth2</span><span class="pi">:</span>
    <span class="na">client</span><span class="pi">:</span>
      <span class="na">client-id</span><span class="pi">:</span> <span class="s">dashboard</span>
      <span class="na">client-secret</span><span class="pi">:</span> <span class="s">dashboard</span>
      <span class="na">access-token-uri</span><span class="pi">:</span> <span class="s">http://localhost:${server.port}/oauth/token</span>
      <span class="na">user-authorization-uri</span><span class="pi">:</span> <span class="s">http://localhost:${server.port}/oauth/authorize</span>
    <span class="na">resource</span><span class="pi">:</span>
      <span class="na">token-info-uri</span><span class="pi">:</span> <span class="s">http://localhost:${server.port}/oauth/check_token</span>
    <span class="na">authorization</span><span class="pi">:</span>
      <span class="na">check-token-access</span><span class="pi">:</span> <span class="s">http://localhost:${server.port}/oauth/check_token</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="application">Application</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.qjdmy.oauth</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.mybatis.spring.annotation.MapperScan</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>

<span class="cm">/**
 * è®¤è¯ä¸æˆæƒ
 *
 * @author Webster
 * @since v1.0.0
 */</span>
<span class="nd">@SpringBootApplication</span><span class="o">(</span><span class="n">scanBasePackages</span> <span class="o">=</span> <span class="s">"com.qjdmy"</span><span class="o">)</span>
<span class="nd">@MapperScan</span><span class="o">(</span><span class="n">basePackages</span> <span class="o">=</span> <span class="s">"com.qjdmy.repository.core.mapper"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthApplication</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">AuthApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="è‡ªå®šä¹‰è®¤è¯æˆæƒå®ç°">è‡ªå®šä¹‰è®¤è¯æˆæƒå®ç°</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.qjdmy.oauth.service.impl</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.qjdmy.repository.core.domain.CoreAdmin</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.qjdmy.repository.core.domain.CoreUser</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.qjdmy.repository.core.mapper.CoreAdminMapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.qjdmy.repository.core.mapper.CoreUserMapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.GrantedAuthority</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.authority.SimpleGrantedAuthority</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.User</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.UserDetails</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.UserDetailsService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.UsernameNotFoundException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.Resource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="cm">/**
 * è‡ªå®šä¹‰è®¤è¯ä¸æˆæƒ
 * @author Webster
 * @since v1.0.0
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserDetailsServiceImpl</span> <span class="kd">implements</span> <span class="nc">UserDetailsService</span> <span class="o">{</span>

    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="nc">CoreAdminMapper</span> <span class="n">coreAdminMapper</span><span class="o">;</span>

    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="nc">CoreUserMapper</span> <span class="n">coreUserMapper</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">UsernameNotFoundException</span> <span class="o">{</span>
        <span class="c1">// ç®¡ç†åå°</span>
        <span class="nc">LambdaQueryWrapper</span><span class="o">&lt;</span><span class="nc">CoreAdmin</span><span class="o">&gt;</span> <span class="n">adminWrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LambdaQueryWrapper</span><span class="o">&lt;&gt;();</span>
        <span class="n">adminWrapper</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="nl">CoreAdmin:</span><span class="o">:</span><span class="n">getUsername</span><span class="o">,</span> <span class="n">username</span><span class="o">);</span>
        <span class="nc">CoreAdmin</span> <span class="n">coreAdmin</span> <span class="o">=</span> <span class="n">coreAdminMapper</span><span class="o">.</span><span class="na">selectOne</span><span class="o">(</span><span class="n">adminWrapper</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">coreAdmin</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// æˆæƒï¼Œç®¡ç†å‘˜æƒé™ä¸º ADMIN</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">grantedAuthorities</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
            <span class="n">grantedAuthorities</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleGrantedAuthority</span><span class="o">(</span><span class="s">"ADMIN"</span><span class="o">));</span>

            <span class="c1">// ç”±æ¡†æ¶å®Œæˆè®¤è¯å·¥ä½œ</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">User</span><span class="o">(</span><span class="n">coreAdmin</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span> <span class="n">coreAdmin</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span> <span class="n">grantedAuthorities</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// é—¨æˆ·ç½‘ç«™</span>
        <span class="nc">LambdaQueryWrapper</span><span class="o">&lt;</span><span class="nc">CoreUser</span><span class="o">&gt;</span> <span class="n">userWrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LambdaQueryWrapper</span><span class="o">&lt;&gt;();</span>
        <span class="n">userWrapper</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="nl">CoreUser:</span><span class="o">:</span><span class="n">getUsername</span><span class="o">,</span> <span class="n">username</span><span class="o">);</span>
        <span class="nc">CoreUser</span> <span class="n">coreUser</span> <span class="o">=</span> <span class="n">coreUserMapper</span><span class="o">.</span><span class="na">selectOne</span><span class="o">(</span><span class="n">userWrapper</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">coreUser</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">grantedAuthorities</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
            <span class="n">grantedAuthorities</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">SimpleGrantedAuthority</span><span class="o">(</span><span class="s">"USERS"</span><span class="o">));</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">User</span><span class="o">(</span><span class="n">coreUser</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span> <span class="n">coreUser</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span> <span class="n">grantedAuthorities</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="è®¤è¯æœåŠ¡å™¨é…ç½®">è®¤è¯æœåŠ¡å™¨é…ç½®</h2>

<ul>
  <li>WebSecurityConfiguration.java</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.qjdmy.oauth.configuration</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.qjdmy.oauth.service.impl.UserDetailsServiceImpl</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.authentication.AuthenticationManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.builders.WebSecurity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.configuration.EnableWebSecurity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.UserDetailsService</span><span class="o">;</span>

<span class="cm">/**
 * è®¤è¯æœåŠ¡å™¨é…ç½®
 *
 * @author Webster
 * @since v1.0.0
 */</span>
<span class="nd">@EnableWebSecurity</span>
<span class="nd">@EnableGlobalMethodSecurity</span><span class="o">(</span><span class="n">prePostEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">securedEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">jsr250Enabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebSecurityConfiguration</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="o">{</span>

	<span class="nd">@Bean</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nc">UserDetailsService</span> <span class="nf">userDetailsServiceBean</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">UserDetailsServiceImpl</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Bean</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nc">AuthenticationManager</span> <span class="nf">authenticationManagerBean</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">authenticationManagerBean</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="n">auth</span><span class="o">.</span><span class="na">userDetailsService</span><span class="o">(</span><span class="n">userDetailsServiceBean</span><span class="o">());</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">WebSecurity</span> <span class="n">web</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// å¿½ç•¥çš„è®¿é—®è·¯å¾„</span>
		<span class="n">web</span><span class="o">.</span><span class="na">ignoring</span><span class="o">()</span>
				<span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/login/**"</span><span class="o">)</span>
				<span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/registry/user"</span><span class="o">)</span>
				<span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/logout/**"</span><span class="o">);</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>AuthorizationServerConfiguration.java</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.qjdmy.oauth.configuration</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.context.properties.ConfigurationProperties</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.jdbc.DataSourceBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Lazy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Primary</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.authentication.AuthenticationManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.UserDetailsService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.provider.ClientDetailsService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.provider.client.JdbcClientDetailsService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.provider.token.TokenStore</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.provider.token.store.JdbcTokenStore</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.Resource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.sql.DataSource</span><span class="o">;</span>

<span class="cm">/**
 * è®¤è¯æœåŠ¡å™¨é…ç½®
 *
 * @author Webster
 * @since v1.0.0
 */</span>
<span class="nd">@Configuration</span>
<span class="nd">@EnableAuthorizationServer</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthorizationServerConfiguration</span> <span class="kd">extends</span> <span class="nc">AuthorizationServerConfigurerAdapter</span> <span class="o">{</span>

	<span class="cm">/**
	 * æ³¨å…¥ç”¨äºæ”¯æŒ password æ¨¡å¼
	 */</span>
	<span class="nd">@Resource</span>
	<span class="kd">private</span> <span class="nc">AuthenticationManager</span> <span class="n">authenticationManager</span><span class="o">;</span>

	<span class="cm">/**
	 * é»˜è®¤çš„åŠ å¯†æ–¹å¼
	 * @return {@link BCryptPasswordEncoder}
	 */</span>
	<span class="nd">@Bean</span>
	<span class="kd">public</span> <span class="nc">BCryptPasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">BCryptPasswordEncoder</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * Refresh Token æ—¶éœ€è¦è‡ªå®šä¹‰å®ç°ï¼Œå¦åˆ™æŠ›å¼‚å¸¸ &lt;br&gt;
	 * Lazy æ³¨è§£æ˜¯ä¸ºäº†é˜²æ­¢å¾ªç¯æ³¨å…¥ï¼ˆis there an unresolvable circular reference?ï¼‰
	 */</span>
	<span class="nd">@Lazy</span>
	<span class="nd">@Resource</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"userDetailsServiceBean"</span><span class="o">)</span>
	<span class="kd">private</span> <span class="nc">UserDetailsService</span> <span class="n">userDetailsService</span><span class="o">;</span>

	<span class="nd">@Bean</span>
	<span class="nd">@Primary</span>
	<span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">"spring.datasource"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">dataSource</span><span class="o">()</span> <span class="o">{</span>
		<span class="c1">// é…ç½®æ•°æ®æºï¼ˆæ³¨æ„ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯ HikariCP è¿æ¥æ± ï¼‰ï¼Œä»¥ä¸Šæ³¨è§£æ˜¯æŒ‡å®šæ•°æ®æºï¼Œå¦åˆ™ä¼šæœ‰å†²çª</span>
		<span class="k">return</span> <span class="nc">DataSourceBuilder</span><span class="o">.</span><span class="na">create</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Bean</span>
	<span class="kd">public</span> <span class="nc">TokenStore</span> <span class="nf">tokenStore</span><span class="o">()</span> <span class="o">{</span>
		<span class="c1">// åŸºäº JDBC å®ç°ï¼Œä»¤ç‰Œä¿å­˜åˆ°æ•°æ®åº“</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">JdbcTokenStore</span><span class="o">(</span><span class="n">dataSource</span><span class="o">());</span>
	<span class="o">}</span>

	<span class="nd">@Bean</span>
	<span class="kd">public</span> <span class="nc">ClientDetailsService</span> <span class="nf">jdbcClientDetailsService</span><span class="o">()</span> <span class="o">{</span>
		<span class="c1">// åŸºäº JDBC å®ç°ï¼Œéœ€è¦äº‹å…ˆåœ¨æ•°æ®åº“é…ç½®å®¢æˆ·ç«¯ä¿¡æ¯</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">JdbcClientDetailsService</span><span class="o">(</span><span class="n">dataSource</span><span class="o">());</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">AuthorizationServerEndpointsConfigurer</span> <span class="n">endpoints</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="n">endpoints</span>
				<span class="c1">// ç”¨äºæ”¯æŒå¯†ç æ¨¡å¼</span>
				<span class="o">.</span><span class="na">authenticationManager</span><span class="o">(</span><span class="n">authenticationManager</span><span class="o">).</span><span class="na">tokenStore</span><span class="o">(</span><span class="n">tokenStore</span><span class="o">());</span>

		<span class="c1">// Refresh Token æ—¶éœ€è¦è‡ªå®šä¹‰å®ç°ï¼Œå¦åˆ™æŠ›å¼‚å¸¸</span>
		<span class="c1">// Handling error: IllegalStateException, UserDetailsService is required.</span>
		<span class="n">endpoints</span><span class="o">.</span><span class="na">userDetailsService</span><span class="o">(</span><span class="n">userDetailsService</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">AuthorizationServerSecurityConfigurer</span> <span class="n">security</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="n">security</span>
				<span class="c1">// å…è®¸å®¢æˆ·ç«¯è®¿é—® /oauth/check_token æ£€æŸ¥ token</span>
				<span class="o">.</span><span class="na">checkTokenAccess</span><span class="o">(</span><span class="s">"isAuthenticated()"</span><span class="o">).</span><span class="na">allowFormAuthenticationForClients</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * é…ç½®å®¢æˆ·ç«¯
	 * @param clients {@link ClientDetailsServiceConfigurer}
	 * @throws Exception å…¨å±€å¼‚å¸¸
	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">ClientDetailsServiceConfigurer</span> <span class="n">clients</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="c1">// å®¢æˆ·ç«¯é…ç½®</span>
		<span class="n">clients</span><span class="o">.</span><span class="na">withClientDetails</span><span class="o">(</span><span class="n">jdbcClientDetailsService</span><span class="o">());</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<h2 id="å®ç°ç™»å½•åŠŸèƒ½">å®ç°ç™»å½•åŠŸèƒ½</h2>

<h3 id="ç™»å½•ä¸šåŠ¡æ¥å£">ç™»å½•ä¸šåŠ¡æ¥å£</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre>package com.qjdmy.oauth.service;

import java.util.Map;

/**
 * ç™»å½•
 * @author Webster
 * @since v1.0.0
 */
public interface ILoginService {
    /**
     * ç™»å½•æˆåŠŸåä»…è¿”å› Token
     * @param username {@code String} è´¦å·
     * @param password {@code String} å¯†ç 
     * @return {@code Map&lt;String, String&gt;} key: token
     */
    Map&lt;String, String&gt; getToken(String username, String password);

    /**
     * åˆ·æ–° Token
     * @param accessToken {@code String} ä½¿ç”¨æ—§ Token æ¢æ–° Token
     * @return {@code Map&lt;String, String&gt;} æ–° Tokenï¼Œkey: token
     */
    Map&lt;String, String&gt; refresh(String accessToken);
}
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="ç™»å½•ä¸šåŠ¡å®ç°">ç™»å½•ä¸šåŠ¡å®ç°</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.qjdmy.oauth.service.impl</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.core.util.StrUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.http.HttpUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.json.JSONObject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.json.JSONUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.qjdmy.commons.exceptions.BusinessException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.qjdmy.commons.response.ResponseCode</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.qjdmy.oauth.service.ILoginService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.UserDetails</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.core.userdetails.UserDetailsService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.Resource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="cm">/**
 * ç™»å½•
 * @author Webster
 * @since v1.0.0
 */</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginServiceImpl</span> <span class="kd">implements</span> <span class="nc">ILoginService</span> <span class="o">{</span>
    <span class="cm">/**
     * TODO ç”¨äºä¸´æ—¶å­˜æ”¾æ‰€æœ‰ Refresh Tokenï¼Œå®é™…æƒ…å†µåº”è¯¥æ”¾åœ¨ Redis ä¸­
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">refreshTokenMaps</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${security.oauth2.client.access-token-uri}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">accessTokenUri</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${security.oauth2.client.client-id}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">clientId</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${security.oauth2.client.client-secret}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">clientSecret</span><span class="o">;</span>

    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="nc">BCryptPasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">;</span>

    <span class="nd">@Resource</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"userDetailsServiceBean"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">UserDetailsService</span> <span class="n">userDetailsService</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getToken</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">,</span> <span class="nc">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>

        <span class="c1">// éªŒè¯å¯†ç æ˜¯å¦æ­£ç¡®</span>
        <span class="nc">UserDetails</span> <span class="n">userDetails</span> <span class="o">=</span> <span class="n">userDetailsService</span><span class="o">.</span><span class="na">loadUserByUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">userDetails</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">passwordEncoder</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">password</span><span class="o">,</span> <span class="n">userDetails</span><span class="o">.</span><span class="na">getPassword</span><span class="o">()))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">BusinessException</span><span class="o">(</span><span class="nc">ResponseCode</span><span class="o">.</span><span class="na">USER_LOGIN_ERROR</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// é€šè¿‡ HTTP å®¢æˆ·ç«¯è¯·æ±‚ç™»å½•æ¥å£</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">authParam</span> <span class="o">=</span> <span class="n">getAuthParam</span><span class="o">();</span>
        <span class="n">authParam</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"username"</span><span class="o">,</span> <span class="n">username</span><span class="o">);</span>
        <span class="n">authParam</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"password"</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
        <span class="n">authParam</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"grant_type"</span><span class="o">,</span> <span class="s">"password"</span><span class="o">);</span>

        <span class="c1">// è·å– access_token</span>
        <span class="nc">String</span> <span class="n">strJson</span> <span class="o">=</span> <span class="nc">HttpUtil</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="n">accessTokenUri</span><span class="o">,</span> <span class="n">authParam</span><span class="o">);</span>
        <span class="nc">JSONObject</span> <span class="n">jsonObject</span> <span class="o">=</span> <span class="nc">JSONUtil</span><span class="o">.</span><span class="na">parseObj</span><span class="o">(</span><span class="n">strJson</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">token</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">jsonObject</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"access_token"</span><span class="o">));</span>
        <span class="nc">String</span> <span class="n">refresh</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">jsonObject</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"refresh_token"</span><span class="o">));</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">StrUtil</span><span class="o">.</span><span class="na">isNotBlank</span><span class="o">(</span><span class="n">token</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="nc">StrUtil</span><span class="o">.</span><span class="na">isNotBlank</span><span class="o">(</span><span class="n">refresh</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// å°† refresh_token ä¿å­˜åœ¨æœåŠ¡ç«¯</span>
            <span class="n">refreshTokenMaps</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">token</span><span class="o">,</span> <span class="n">refresh</span><span class="o">);</span>

            <span class="c1">// å°† access_token è¿”å›ç»™å®¢æˆ·ç«¯</span>
            <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"token"</span><span class="o">,</span> <span class="n">token</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">refresh</span><span class="o">(</span><span class="nc">String</span> <span class="n">accessToken</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>

        <span class="c1">// Access Token ä¸å­˜åœ¨ç›´æ¥è¿”å› null</span>
        <span class="nc">String</span> <span class="n">refreshToken</span> <span class="o">=</span> <span class="n">refreshTokenMaps</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">accessToken</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">StrUtil</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">refreshToken</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">BusinessException</span><span class="o">(</span><span class="nc">ResponseCode</span><span class="o">.</span><span class="na">USER_NOT_LOGGED_IN</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// é€šè¿‡ HTTP å®¢æˆ·ç«¯è¯·æ±‚ç™»å½•æ¥å£</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">authParam</span> <span class="o">=</span> <span class="n">getAuthParam</span><span class="o">();</span>
        <span class="n">authParam</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"grant_type"</span><span class="o">,</span> <span class="s">"refresh_token"</span><span class="o">);</span>
        <span class="n">authParam</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"refresh_token"</span><span class="o">,</span> <span class="n">refreshToken</span><span class="o">);</span>

        <span class="c1">// è·å– access_token</span>
        <span class="nc">String</span> <span class="n">strJson</span> <span class="o">=</span> <span class="nc">HttpUtil</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="n">accessTokenUri</span><span class="o">,</span> <span class="n">authParam</span><span class="o">);</span>
        <span class="nc">JSONObject</span> <span class="n">jsonObject</span> <span class="o">=</span> <span class="nc">JSONUtil</span><span class="o">.</span><span class="na">parseObj</span><span class="o">(</span><span class="n">strJson</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">token</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">jsonObject</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"access_token"</span><span class="o">));</span>
        <span class="nc">String</span> <span class="n">refresh</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">jsonObject</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"refresh_token"</span><span class="o">));</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">StrUtil</span><span class="o">.</span><span class="na">isNotBlank</span><span class="o">(</span><span class="n">token</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="nc">StrUtil</span><span class="o">.</span><span class="na">isNotBlank</span><span class="o">(</span><span class="n">refresh</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// åˆ é™¤æ—§ Token</span>
            <span class="n">refreshTokenMaps</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">accessToken</span><span class="o">);</span>

            <span class="c1">// å°† refresh_token ä¿å­˜åœ¨æœåŠ¡ç«¯</span>
            <span class="n">refreshTokenMaps</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">token</span><span class="o">,</span> <span class="n">refresh</span><span class="o">);</span>

            <span class="c1">// å°† access_token è¿”å›ç»™å®¢æˆ·ç«¯</span>
            <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"token"</span><span class="o">,</span> <span class="n">token</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// ç§æœ‰æ–¹æ³• ------------------------------------------- Begin</span>

    <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">getAuthParam</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">param</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">param</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"client_id"</span><span class="o">,</span> <span class="n">clientId</span><span class="o">);</span>
        <span class="n">param</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"client_secret"</span><span class="o">,</span> <span class="n">clientSecret</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">param</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="å°è£…å·¥å…·ç±»">å°è£…å·¥å…·ç±»</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.qjdmy.commons.web</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.core.util.StrUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.qjdmy.commons.exceptions.BusinessException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.qjdmy.commons.response.ResponseCode</span><span class="o">;</span>

<span class="cm">/**
 * è¯·æ±‚å¤´å¤„ç†
 * @author Webster
 * @since v1.0.0
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Header</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">AUTHORIZATION_BEARER_TOKEN</span> <span class="o">=</span> <span class="s">"Basic "</span><span class="o">;</span>

    <span class="cm">/**
     * è·å– Token
     * @param header {@code String} request.getHeader("Authorization")
     * @return {@code String} token
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">getAuthorization</span><span class="o">(</span><span class="nc">String</span> <span class="n">header</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">StrUtil</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">header</span><span class="o">)</span> <span class="o">||</span> <span class="n">header</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="no">AUTHORIZATION_BEARER_TOKEN</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">BusinessException</span><span class="o">(</span><span class="nc">ResponseCode</span><span class="o">.</span><span class="na">USER_NOT_LOGGED_IN</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">header</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="no">AUTHORIZATION_BEARER_TOKEN</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="å°è£…è¯·æ±‚å‚æ•°">å°è£…è¯·æ±‚å‚æ•°</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.qjdmy.oauth.controller.param</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.EqualsAndHashCode</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.experimental.Accessors</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="cm">/**
 * ç™»å½•å‚æ•°
 * @author Webster
 * @since v1.0.0
 */</span>
<span class="nd">@Data</span>
<span class="nd">@EqualsAndHashCode</span><span class="o">(</span><span class="n">callSuper</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="nd">@Accessors</span><span class="o">(</span><span class="n">chain</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginParam</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">6227804428105653962L</span><span class="o">;</span>

    <span class="cm">/**
     * è´¦å·
     */</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>

    <span class="cm">/**
     * å¯†ç 
     */</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="è¯·æ±‚å¤„ç†ä»£ç ">è¯·æ±‚å¤„ç†ä»£ç </h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.qjdmy.oauth.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.qfdmy.commons.response.ResponseResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.qfdmy.commons.web.Header</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.qfdmy.oauth.controller.param.LoginParam</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.qfdmy.oauth.service.ILoginService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PostMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestBody</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.Resource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>

<span class="cm">/**
 * ç™»å½•
 * @author Webster
 * @since v1.0.0
 */</span>
<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"login"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginController</span> <span class="o">{</span>

    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">;</span>

    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="nc">ILoginService</span> <span class="n">loginService</span><span class="o">;</span>

    <span class="cm">/**
     * ç®¡ç†å‘˜ç™»å½•
     * @param loginParam {@code JSON} {@link LoginParam}
     * @return {@link ResponseResult}
     */</span>
    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"admin"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">ResponseResult</span> <span class="nf">admin</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">LoginParam</span> <span class="n">loginParam</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">ResponseResult</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">loginService</span><span class="o">.</span><span class="na">getToken</span><span class="o">(</span><span class="n">loginParam</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span> <span class="n">loginParam</span><span class="o">.</span><span class="na">getPassword</span><span class="o">()));</span>
    <span class="o">}</span>

    <span class="cm">/**
     * ç”¨æˆ·ç™»å½•ï¼Œç™»å½•åªæ˜¯æ‹¿ Token
     * @param loginParam {@code JSON} {@link LoginParam}
     * @return {@link ResponseResult}
     */</span>
    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"user"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">ResponseResult</span> <span class="nf">users</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">LoginParam</span> <span class="n">loginParam</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">ResponseResult</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">loginService</span><span class="o">.</span><span class="na">getToken</span><span class="o">(</span><span class="n">loginParam</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span> <span class="n">loginParam</span><span class="o">.</span><span class="na">getPassword</span><span class="o">()));</span>
    <span class="o">}</span>

    <span class="cm">/**
     * åˆ·æ–°ä»¤ç‰Œ
     * @return {@link ResponseResult}
     */</span>
    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"refresh"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">ResponseResult</span> <span class="nf">refresh</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">token</span> <span class="o">=</span> <span class="nc">Header</span><span class="o">.</span><span class="na">getAuthorization</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"Authorization"</span><span class="o">));</span>
        <span class="k">return</span> <span class="nc">ResponseResult</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">loginService</span><span class="o">.</span><span class="na">refresh</span><span class="o">(</span><span class="n">token</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å®ç°æ³¨é”€åŠŸèƒ½">å®ç°æ³¨é”€åŠŸèƒ½</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.qjdmy.oauth.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.qjdmy.commons.response.ResponseCode</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.qjdmy.commons.response.ResponseResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.qjdmy.commons.web.Header</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.common.OAuth2AccessToken</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.provider.token.TokenStore</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PostMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.Resource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>

<span class="cm">/**
 * æ³¨é”€
 *
 * @author Webster
 * @since v1.0.0
 */</span>
<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"logout"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogoutController</span> <span class="o">{</span>
    <span class="nd">@Resource</span>
    <span class="kd">public</span> <span class="nc">TokenStore</span> <span class="n">tokenStore</span><span class="o">;</span>

    <span class="nd">@Resource</span>
    <span class="kd">public</span> <span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">;</span>

    <span class="cm">/**
     * æ³¨é”€ç®¡ç†å‘˜
     *
     * @return {@link ResponseResult}
     */</span>
    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"admin"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">ResponseResult</span> <span class="nf">admin</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">logout</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * æ³¨é”€ç”¨æˆ·
     *
     * @return {@link ResponseResult}
     */</span>
    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"user"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">ResponseResult</span> <span class="nf">users</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">logout</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// ç§æœ‰æ–¹æ³• ------------------------------------------- Begin</span>

    <span class="kd">private</span> <span class="nc">ResponseResult</span> <span class="nf">logout</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">token</span> <span class="o">=</span> <span class="nc">Header</span><span class="o">.</span><span class="na">getAuthorization</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"Authorization"</span><span class="o">));</span>

        <span class="c1">// åˆ é™¤ token ä»¥æ³¨é”€</span>
        <span class="nc">OAuth2AccessToken</span> <span class="n">oAuth2AccessToken</span> <span class="o">=</span> <span class="n">tokenStore</span><span class="o">.</span><span class="na">readAccessToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">oAuth2AccessToken</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">tokenStore</span><span class="o">.</span><span class="na">removeAccessToken</span><span class="o">(</span><span class="n">oAuth2AccessToken</span><span class="o">);</span>
            <span class="k">return</span> <span class="nc">ResponseResult</span><span class="o">.</span><span class="na">success</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="nc">ResponseResult</span><span class="o">.</span><span class="na">failure</span><span class="o">(</span><span class="nc">ResponseCode</span><span class="o">.</span><span class="na">INTERFACE_ADDRESS_INVALID</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="èµ„æºæœåŠ¡å™¨é…ç½®">èµ„æºæœåŠ¡å™¨é…ç½®</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.qjdmy.all.configuration</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.builders.HttpSecurity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.annotation.web.configurers.ExpressionUrlAuthorizationConfigurer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.config.http.SessionCreationPolicy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.config.annotation.web.configuration.EnableResourceServer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.config.annotation.web.configuration.ResourceServerConfigurerAdapter</span><span class="o">;</span>

<span class="cm">/**
 * èµ„æºæœåŠ¡å™¨é…ç½®
 *
 * @author Webster
 * @since v1.0.0
 */</span>
<span class="nd">@EnableResourceServer</span>
<span class="nd">@EnableGlobalMethodSecurity</span><span class="o">(</span><span class="n">prePostEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">securedEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">jsr250Enabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ResourceServerConfiguration</span> <span class="kd">extends</span> <span class="nc">ResourceServerConfigurerAdapter</span> <span class="o">{</span>

    <span class="cm">/**
     * ç®¡ç†å‘˜è§’è‰²
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ADMIN</span> <span class="o">=</span> <span class="s">"ADMIN"</span><span class="o">;</span>

    <span class="cm">/**
     * ç”¨æˆ·è§’è‰²
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">USERS</span> <span class="o">=</span> <span class="s">"USERS"</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">// å…è®¸è®¿é—®å…¨éƒ¨èµ„æº</span>
<span class="c1">//		http.exceptionHandling().and().sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span>
<span class="c1">//				.and().authorizeRequests().antMatchers("/**").permitAll();</span>

        <span class="c1">// ç®¡ç†å‘˜æˆæƒè¯·æ±‚è·¯å¾„</span>
        <span class="nc">String</span><span class="o">[]</span> <span class="n">adminPaths</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span>
                <span class="s">"/core/**"</span><span class="o">,</span> <span class="s">"/qiniu/**"</span>
        <span class="o">};</span>

        <span class="nc">ExpressionUrlAuthorizationConfigurer</span><span class="o">&lt;</span><span class="nc">HttpSecurity</span><span class="o">&gt;.</span><span class="na">ExpressionInterceptUrlRegistry</span>
                <span class="n">expressionInterceptUrlRegistry</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="na">exceptionHandling</span><span class="o">()</span>
                <span class="o">.</span><span class="na">and</span><span class="o">().</span><span class="na">sessionManagement</span><span class="o">().</span><span class="na">sessionCreationPolicy</span><span class="o">(</span><span class="nc">SessionCreationPolicy</span><span class="o">.</span><span class="na">STATELESS</span><span class="o">)</span>
                <span class="o">.</span><span class="na">and</span><span class="o">().</span><span class="na">authorizeRequests</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">adminPath</span> <span class="o">:</span> <span class="n">adminPaths</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">expressionInterceptUrlRegistry</span><span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="n">adminPath</span><span class="o">).</span><span class="na">hasAnyAuthority</span><span class="o">(</span><span class="no">ADMIN</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>]]></content><author><name>tangyuewei</name></author><category term="å¸¸ç”¨æ¡†æ¶" /><category term="oAuth2" /><category term="Spring Security" /><summary type="html"><![CDATA[æ•°æ®è¡¨]]></summary></entry><entry><title type="html">Spring Security oAuth2ç®€ä»‹</title><link href="https://tangyuewei.github.io/posts/Spring-Security-oAuth2%E7%AE%80%E4%BB%8B/" rel="alternate" type="text/html" title="Spring Security oAuth2ç®€ä»‹" /><published>2023-03-07T19:15:00+08:00</published><updated>2023-03-07T19:15:00+08:00</updated><id>https://tangyuewei.github.io/posts/Spring%20Security%20oAuth2%E7%AE%80%E4%BB%8B</id><content type="html" xml:base="https://tangyuewei.github.io/posts/Spring-Security-oAuth2%E7%AE%80%E4%BB%8B/"><![CDATA[<h1 id="ä»€ä¹ˆæ˜¯-oauth">ä»€ä¹ˆæ˜¯ oAuth</h1>

<p><code class="language-plaintext highlighter-rouge">oAuth</code>åè®®ä¸ºç”¨æˆ·èµ„æºçš„æˆæƒæä¾›äº†ä¸€ä¸ªå®‰å…¨çš„ã€å¼€æ”¾è€Œåˆç®€æ˜“çš„æ ‡å‡†ã€‚ä¸ä»¥å¾€çš„æˆæƒæ–¹å¼ä¸åŒä¹‹å¤„æ˜¯ <code class="language-plaintext highlighter-rouge">oAuth</code>çš„æˆæƒä¸ä¼šä½¿ç¬¬ä¸‰æ–¹è§¦åŠåˆ°ç”¨æˆ·çš„å¸å·ä¿¡æ¯ï¼ˆå¦‚ç”¨æˆ·åä¸å¯†ç ï¼‰ï¼Œå³ç¬¬ä¸‰æ–¹æ— éœ€ä½¿ç”¨ç”¨æˆ·çš„ç”¨æˆ·åä¸å¯†ç å°±å¯ä»¥ç”³è¯·è·å¾—è¯¥ç”¨æˆ·èµ„æºçš„æˆæƒï¼Œå› æ­¤<code class="language-plaintext highlighter-rouge">oAuth</code>æ˜¯å®‰å…¨çš„ã€‚</p>

<h1 id="ä»€ä¹ˆæ˜¯-spring-security">ä»€ä¹ˆæ˜¯ Spring Security</h1>

<p><code class="language-plaintext highlighter-rouge">Spring Security</code>æ˜¯ä¸€ä¸ªå®‰å…¨æ¡†æ¶ï¼Œå‰èº«æ˜¯<code class="language-plaintext highlighter-rouge">Acegi Security</code>ï¼Œèƒ½å¤Ÿä¸º<code class="language-plaintext highlighter-rouge">Spring</code>ä¼ä¸šåº”ç”¨ç³»ç»Ÿæä¾›å£°æ˜å¼çš„å®‰å…¨è®¿é—®æ§åˆ¶ã€‚<code class="language-plaintext highlighter-rouge">Spring Security</code>åŸºäº<code class="language-plaintext highlighter-rouge">Servlet</code> è¿‡æ»¤å™¨ã€IoC å’Œ AOPï¼Œä¸º Web è¯·æ±‚å’Œæ–¹æ³•è°ƒç”¨æä¾›èº«ä»½ç¡®è®¤å’Œæˆæƒå¤„ç†ï¼Œé¿å…äº†ä»£ç è€¦åˆï¼Œå‡å°‘äº†å¤§é‡é‡å¤ä»£ç å·¥ä½œã€‚</p>

<h1 id="ä¸ºä»€ä¹ˆéœ€è¦-oauth2">ä¸ºä»€ä¹ˆéœ€è¦ oAuth2</h1>

<h2 id="åº”ç”¨åœºæ™¯">åº”ç”¨åœºæ™¯</h2>

<p>æˆ‘ä»¬å‡è®¾ä½ æœ‰ä¸€ä¸ªâ€œäº‘ç¬”è®°â€äº§å“ï¼Œå¹¶æä¾›äº†â€œäº‘ç¬”è®°æœåŠ¡â€å’Œâ€œäº‘ç›¸å†ŒæœåŠ¡â€ï¼Œæ­¤æ—¶ç”¨æˆ·éœ€è¦åœ¨ä¸åŒçš„è®¾å¤‡ï¼ˆPCã€Androidã€iPhoneã€TVã€Watchï¼‰ä¸Šå»è®¿é—®è¿™äº›â€œèµ„æºâ€ï¼ˆç¬”è®°ï¼Œå›¾ç‰‡ï¼‰</p>

<p>é‚£ä¹ˆç”¨æˆ·å¦‚ä½•æ‰èƒ½è®¿é—®å±äºè‡ªå·±çš„é‚£éƒ¨åˆ†èµ„æºå‘¢ï¼Ÿæ­¤æ—¶ä¼ ç»Ÿçš„åšæ³•å°±æ˜¯æä¾›è‡ªå·±çš„è´¦å·å’Œå¯†ç ç»™æˆ‘ä»¬çš„â€œäº‘ç¬”è®°â€ï¼Œç™»å½•æˆåŠŸåå°±å¯ä»¥è·å–èµ„æºäº†ã€‚ä½†è¿™æ ·çš„åšæ³•ä¼šæœ‰ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p>

<p>â€œäº‘ç¬”è®°æœåŠ¡â€å’Œâ€œäº‘ç›¸å†ŒæœåŠ¡â€ä¼šåˆ†åˆ«éƒ¨ç½²ï¼Œéš¾é“æˆ‘ä»¬è¦åˆ†åˆ«ç™»å½•å—ï¼Ÿ
å¦‚æœæœ‰ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºæƒ³è¦æ¥å…¥æˆ‘ä»¬çš„â€œäº‘ç¬”è®°â€ï¼Œéš¾é“éœ€è¦ç”¨æˆ·æä¾›è´¦å·å’Œå¯†ç ç»™ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºï¼Œè®©ä»–è®°å½•åå†è®¿é—®æˆ‘ä»¬çš„èµ„æºå—ï¼Ÿ
ç”¨æˆ·å¦‚ä½•é™åˆ¶ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºåœ¨æˆ‘ä»¬â€œäº‘ç¬”è®°â€çš„æˆæƒèŒƒå›´å’Œä½¿ç”¨æœŸé™ï¼Ÿéš¾é“æŠŠæ‰€æœ‰èµ„æ–™éƒ½æ°¸ä¹…æš´éœ²ç»™å®ƒå—ï¼Ÿ
å¦‚æœç”¨æˆ·ä¿®æ”¹äº†å¯†ç æ”¶å›äº†æƒé™ï¼Œé‚£ä¹ˆæ‰€æœ‰ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºä¼šå…¨éƒ¨å¤±æ•ˆã€‚
åªè¦æœ‰ä¸€ä¸ªæ¥å…¥çš„ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºé­åˆ°ç ´è§£ï¼Œé‚£ä¹ˆç”¨æˆ·çš„å¯†ç å°±ä¼šæ³„éœ²ï¼Œåæœä¸å ªè®¾æƒ³ã€‚
ä¸ºäº†è§£å†³å¦‚ä¸Šé—®é¢˜ï¼Œ<code class="language-plaintext highlighter-rouge">oAuth</code>åº”ç”¨è€Œç”Ÿã€‚</p>

<h2 id="åè¯è§£é‡Š">åè¯è§£é‡Š</h2>

<ul>
  <li><b>ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºï¼ˆThird-party applicationï¼‰</b>ï¼š åˆç§°ä¹‹ä¸ºå®¢æˆ·ç«¯ï¼ˆclientï¼‰ï¼Œæ¯”å¦‚ä¸ŠèŠ‚ä¸­æåˆ°çš„è®¾å¤‡ï¼ˆPCã€Androidã€iPhoneã€TVã€Watchï¼‰ï¼Œæˆ‘ä»¬ä¼šåœ¨è¿™äº›è®¾å¤‡ä¸­å®‰è£…æˆ‘ä»¬è‡ªå·±ç ”å‘çš„ APPã€‚åˆæ¯”å¦‚æˆ‘ä»¬çš„äº§å“æƒ³è¦ä½¿ç”¨ QQã€å¾®ä¿¡ç­‰ç¬¬ä¸‰æ–¹ç™»å½•ã€‚å¯¹æˆ‘ä»¬çš„äº§å“æ¥è¯´ï¼ŒQQã€å¾®ä¿¡ç™»å½•æ˜¯ç¬¬ä¸‰æ–¹ç™»å½•ç³»ç»Ÿã€‚æˆ‘ä»¬åˆéœ€è¦ç¬¬ä¸‰æ–¹ç™»å½•ç³»ç»Ÿçš„èµ„æºï¼ˆå¤´åƒã€æ˜µç§°ç­‰ï¼‰ã€‚å¯¹äº QQã€å¾®ä¿¡ç­‰ç³»ç»Ÿæˆ‘ä»¬åˆæ˜¯ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºã€‚</li>
  <li><b>HTTP æœåŠ¡æä¾›å•†ï¼ˆHTTP serviceï¼‰</b>ï¼š æˆ‘ä»¬çš„äº‘ç¬”è®°äº§å“ä»¥åŠ QQã€å¾®ä¿¡ç­‰éƒ½å¯ä»¥ç§°ä¹‹ä¸ºâ€œæœåŠ¡æä¾›å•†â€ã€‚</li>
  <li><b>èµ„æºæ‰€æœ‰è€…ï¼ˆResource Ownerï¼‰<b>ï¼š åˆç§°ä¹‹ä¸ºç”¨æˆ·ï¼ˆuserï¼‰ã€‚
ç”¨æˆ·ä»£ç†ï¼ˆUser Agentï¼‰ï¼š æ¯”å¦‚æµè§ˆå™¨ï¼Œä»£æ›¿ç”¨æˆ·å»è®¿é—®è¿™äº›èµ„æºã€‚</b></b></li>
  <li><b>è®¤è¯æœåŠ¡å™¨ï¼ˆAuthorization serverï¼‰<b>ï¼š å³æœåŠ¡æä¾›å•†ä¸“é—¨ç”¨æ¥å¤„ç†è®¤è¯çš„æœåŠ¡å™¨ï¼Œç®€å•ç‚¹è¯´å°±æ˜¯ç™»å½•åŠŸèƒ½ï¼ˆéªŒè¯ç”¨æˆ·çš„è´¦å·å¯†ç æ˜¯å¦æ­£ç¡®ä»¥åŠåˆ†é…ç›¸åº”çš„æƒé™ï¼‰</b></b></li>
  <li><b>èµ„æºæœåŠ¡å™¨ï¼ˆResource serverï¼‰<b>ï¼š å³æœåŠ¡æä¾›å•†å­˜æ”¾ç”¨æˆ·ç”Ÿæˆçš„èµ„æºçš„æœåŠ¡å™¨ã€‚å®ƒä¸è®¤è¯æœåŠ¡å™¨ï¼Œå¯ä»¥æ˜¯åŒä¸€å°æœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸åŒçš„æœåŠ¡å™¨ã€‚ç®€å•ç‚¹è¯´å°±æ˜¯èµ„æºçš„è®¿é—®å…¥å£ï¼Œæ¯”å¦‚ä¸ŠèŠ‚ä¸­æåˆ°çš„â€œäº‘ç¬”è®°æœåŠ¡â€å’Œâ€œäº‘ç›¸å†ŒæœåŠ¡â€éƒ½å¯ä»¥ç§°ä¹‹ä¸ºèµ„æºæœåŠ¡å™¨ã€‚</b></b></li>
</ul>

<h2 id="äº¤äº’è¿‡ç¨‹">äº¤äº’è¿‡ç¨‹</h2>

<p>oAuth åœ¨ â€œå®¢æˆ·ç«¯â€ ä¸ â€œæœåŠ¡æä¾›å•†â€ ä¹‹é—´ï¼Œè®¾ç½®äº†ä¸€ä¸ªæˆæƒå±‚ï¼ˆauthorization layerï¼‰ã€‚â€å®¢æˆ·ç«¯â€ ä¸èƒ½ç›´æ¥ç™»å½• â€œæœåŠ¡æä¾›å•†â€ï¼Œåªèƒ½ç™»å½•æˆæƒå±‚ï¼Œä»¥æ­¤å°†ç”¨æˆ·ä¸å®¢æˆ·ç«¯åŒºåˆ†å¼€æ¥ã€‚â€å®¢æˆ·ç«¯â€ ç™»å½•æˆæƒå±‚æ‰€ç”¨çš„ä»¤ç‰Œï¼ˆtokenï¼‰ï¼Œä¸ç”¨æˆ·çš„å¯†ç ä¸åŒã€‚ç”¨æˆ·å¯ä»¥åœ¨ç™»å½•çš„æ—¶å€™ï¼ŒæŒ‡å®šæˆæƒå±‚ä»¤ç‰Œçš„æƒé™èŒƒå›´å’Œæœ‰æ•ˆæœŸã€‚â€å®¢æˆ·ç«¯â€ ç™»å½•æˆæƒå±‚ä»¥åï¼Œâ€æœåŠ¡æä¾›å•†â€ æ ¹æ®ä»¤ç‰Œçš„æƒé™èŒƒå›´å’Œæœ‰æ•ˆæœŸï¼Œå‘ â€œå®¢æˆ·ç«¯â€ å¼€æ”¾ç”¨æˆ·å‚¨å­˜çš„èµ„æ–™ã€‚</p>

<h1 id="å¼€æ”¾å¹³å°">å¼€æ”¾å¹³å°</h1>

<h2 id="äº¤äº’æ¨¡å‹">äº¤äº’æ¨¡å‹</h2>

<p>äº¤äº’æ¨¡å‹æ¶‰åŠä¸‰æ–¹ï¼š</p>

<ul>
  <li>èµ„æºæ‹¥æœ‰è€…ï¼šç”¨æˆ·</li>
  <li>å®¢æˆ·ç«¯ï¼šAPP</li>
  <li>æœåŠ¡æä¾›æ–¹ï¼šåŒ…å«ä¸¤ä¸ªè§’è‰²</li>
</ul>

<p>1.</p>
<ul>
  <li>è®¤è¯æœåŠ¡å™¨
2.</li>
  <li>èµ„æºæœåŠ¡å™¨</li>
</ul>

<h2 id="è®¤è¯æœåŠ¡å™¨">è®¤è¯æœåŠ¡å™¨</h2>

<p>è®¤è¯æœåŠ¡å™¨è´Ÿè´£å¯¹ç”¨æˆ·è¿›è¡Œè®¤è¯ï¼Œå¹¶æˆæƒç»™å®¢æˆ·ç«¯æƒé™ã€‚è®¤è¯å¾ˆå®¹æ˜“å®ç°ï¼ˆéªŒè¯è´¦å·å¯†ç å³å¯ï¼‰ï¼Œé—®é¢˜åœ¨äºå¦‚ä½•æˆæƒã€‚æ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨ç¬¬ä¸‰æ–¹ç™»å½• â€œæœ‰é“äº‘ç¬”è®°â€ï¼Œä½ å¯ä»¥çœ‹åˆ°å¦‚ä½¿ç”¨ QQ ç™»å½•çš„æˆæƒé¡µé¢ä¸Šæœ‰ â€œæœ‰é“äº‘ç¬”è®°å°†è·å¾—ä»¥ä¸‹æƒé™â€ çš„å­—æ ·ä»¥åŠæƒé™ä¿¡æ¯è®¤è¯æœåŠ¡å™¨éœ€è¦çŸ¥é“è¯·æ±‚æˆæƒçš„å®¢æˆ·ç«¯çš„èº«ä»½ä»¥åŠè¯¥å®¢æˆ·ç«¯è¯·æ±‚çš„æƒé™ã€‚æˆ‘ä»¬å¯ä»¥ä¸ºæ¯ä¸€ä¸ªå®¢æˆ·ç«¯é¢„å…ˆåˆ†é…ä¸€ä¸ª idï¼Œå¹¶ç»™æ¯ä¸ª id å¯¹åº”ä¸€ä¸ªåç§°ä»¥åŠæƒé™ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯å¯ä»¥å†™åœ¨è®¤è¯æœåŠ¡å™¨ä¸Šçš„é…ç½®æ–‡ä»¶é‡Œã€‚ç„¶åï¼Œå®¢æˆ·ç«¯æ¯æ¬¡æ‰“å¼€æˆæƒé¡µé¢çš„æ—¶å€™ï¼ŒæŠŠå±äºè‡ªå·±çš„ id ä¼ è¿‡æ¥ï¼Œå¦‚ï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>http://www.tangyuewei.com/login?client_id=yourClientId
</pre></td></tr></tbody></table></code></pre></div></div>
<p>éšç€æ—¶é—´çš„æ¨ç§»å’Œä¸šåŠ¡çš„å¢é•¿ï¼Œä¼šå‘ç°ï¼Œä¿®æ”¹é…ç½®çš„å·¥ä½œæ¶ˆè€—äº†å¤ªå¤šçš„äººåŠ›ã€‚æœ‰æ²¡æœ‰åŠæ³•æŠŠè¿™ä¸ªè¿‡ç¨‹è‡ªåŠ¨åŒ–èµ·æ¥ï¼ŒæŠŠäººå·¥ä»è¿™äº›ç¹ççš„æ“ä½œä¸­è§£æ”¾å‡ºæ¥ï¼Ÿå½“å¼€å§‹è€ƒè™‘è¿™ä¸€æ­¥ï¼Œå¼€æ”¾å¹³å°çš„æˆå‹ä¹Ÿå°±æ˜¯æ°´åˆ°æ¸ æˆçš„äº‹æƒ…äº†ã€‚</p>

<h2 id="oauth2-å¼€æ”¾å¹³å°">oAuth2 å¼€æ”¾å¹³å°</h2>

<p>å¼€æ”¾å¹³å°æ˜¯ç”± oAuth2.0 åè®®è¡ç”Ÿå‡ºæ¥çš„ä¸€ä¸ªäº§å“ã€‚å®ƒçš„ä½œç”¨æ˜¯è®©å®¢æˆ·ç«¯è‡ªå·±å»è¿™ä¸Šé¢è¿›è¡Œæ³¨å†Œã€ç”³è¯·ï¼Œé€šè¿‡ä¹‹åç³»ç»Ÿè‡ªåŠ¨åˆ†é…<code class="language-plaintext highlighter-rouge">client_id</code>ï¼Œå¹¶å®Œæˆé…ç½®çš„è‡ªåŠ¨æ›´æ–°ï¼ˆé€šå¸¸æ˜¯å†™è¿›æ•°æ®åº“ï¼‰ã€‚</p>

<p>å®¢æˆ·ç«¯è¦å®Œæˆç”³è¯·ï¼Œé€šå¸¸éœ€è¦å¡«å†™å®¢æˆ·ç«¯ç¨‹åºçš„ç±»å‹ï¼ˆWebã€App ç­‰ï¼‰ã€ä¼ä¸šä»‹ç»ã€æ‰§ç…§ã€æƒ³è¦è·å–çš„æƒé™ç­‰ç­‰ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯åœ¨å¾—åˆ°æœåŠ¡æä¾›æ–¹çš„äººå·¥å®¡æ ¸é€šè¿‡åï¼Œå¼€å‘å¹³å°å°±ä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">client_id</code>ç»™å®¢æˆ·ç«¯äº†ã€‚</p>

<p>åˆ°è¿™é‡Œï¼Œå·²ç»å®ç°äº†ç™»å½•è®¤è¯ã€æˆæƒé¡µçš„ä¿¡æ¯å±•ç¤ºã€‚é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œå½“ç”¨æˆ·æˆåŠŸè¿›è¡Œæˆæƒä¹‹åï¼Œè®¤è¯æœåŠ¡å™¨éœ€è¦æŠŠäº§ç”Ÿçš„<code class="language-plaintext highlighter-rouge">access_token</code>å‘é€ç»™å®¢æˆ·ç«¯ï¼Œæ–¹æ¡ˆå¦‚ä¸‹ï¼š</p>

<ul>
  <li>è®©å®¢æˆ·ç«¯åœ¨å¼€æ”¾å¹³å°ç”³è¯·çš„æ—¶å€™ï¼Œå¡«å†™ä¸€ä¸ª URLï¼Œä¾‹å¦‚ï¼š<a href="http://www.tangyuewei.com">http://www.tangyuewei.com</a></li>
  <li>æ¯æ¬¡å½“æœ‰ç”¨æˆ·æˆæƒæˆåŠŸä¹‹åï¼Œè®¤è¯æœåŠ¡å™¨å°†é¡µé¢é‡å®šå‘åˆ°è¿™ä¸ªURLï¼ˆå›è°ƒï¼‰ï¼Œå¹¶å¸¦<code class="language-plaintext highlighter-rouge">ä¸Šaccess_token</code>ï¼Œä¾‹å¦‚ï¼š<code class="language-plaintext highlighter-rouge">http://www.tangyuewei.com?access_token=123456789</code></li>
  <li>å®¢æˆ·ç«¯æ¥æ”¶åˆ°äº†è¿™ä¸ª<code class="language-plaintext highlighter-rouge">access_token</code>ï¼Œè€Œä¸”è®¤è¯æœåŠ¡å™¨çš„æˆæƒåŠ¨ä½œå·²ç»å®Œæˆï¼Œåˆšå¥½å¯ä»¥æŠŠç¨‹åºçš„æ§åˆ¶æƒè½¬äº¤å›å®¢æˆ·ç«¯ï¼Œç”±å®¢æˆ·ç«¯å†³å®šæ¥ä¸‹æ¥å‘ç”¨æˆ·å±•ç¤ºä»€ä¹ˆå†…å®¹ã€‚</li>
</ul>

<h1 id="ä»¤ç‰Œçš„è®¿é—®ä¸åˆ·æ–°">ä»¤ç‰Œçš„è®¿é—®ä¸åˆ·æ–°</h1>

<h2 id="access-token">Access Token</h2>

<p>Access Token æ˜¯å®¢æˆ·ç«¯è®¿é—®èµ„æºæœåŠ¡å™¨çš„ä»¤ç‰Œã€‚æ‹¥æœ‰è¿™ä¸ªä»¤ç‰Œä»£è¡¨ç€å¾—åˆ°ç”¨æˆ·çš„æˆæƒã€‚ç„¶è€Œï¼Œè¿™ä¸ªæˆæƒåº”è¯¥æ˜¯<b>ä¸´æ—¶</b>çš„ï¼Œæœ‰ä¸€å®šæœ‰æ•ˆæœŸã€‚è¿™æ˜¯å› ä¸ºï¼ŒAccess Token åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­<b>å¯èƒ½ä¼šæ³„éœ²</b>ã€‚ç»™ Access Token é™å®šä¸€ä¸ª è¾ƒçŸ­çš„æœ‰æ•ˆæœŸ å¯ä»¥é™ä½å›  Access Token æ³„éœ²è€Œå¸¦æ¥çš„é£é™©ã€‚</p>

<p>ç„¶è€Œå¼•å…¥äº†æœ‰æ•ˆæœŸä¹‹åï¼Œå®¢æˆ·ç«¯ä½¿ç”¨èµ·æ¥å°±ä¸é‚£ä¹ˆæ–¹ä¾¿äº†ã€‚æ¯å½“ Access Token è¿‡æœŸï¼Œå®¢æˆ·ç«¯å°±å¿…é¡»é‡æ–°å‘ç”¨æˆ·ç´¢è¦æˆæƒã€‚è¿™æ ·ç”¨æˆ·å¯èƒ½æ¯éš”å‡ å¤©ï¼Œç”šè‡³æ¯å¤©éƒ½éœ€è¦è¿›è¡Œæˆæƒæ“ä½œã€‚è¿™æ˜¯ä¸€ä»¶éå¸¸å½±å“ç”¨æˆ·ä½“éªŒçš„äº‹æƒ…ã€‚å¸Œæœ›æœ‰ä¸€ç§æ–¹æ³•ï¼Œå¯ä»¥é¿å…è¿™ç§æƒ…å†µã€‚</p>

<p>äºæ˜¯<code class="language-plaintext highlighter-rouge">oAuth2.0</code>å¼•å…¥äº†<code class="language-plaintext highlighter-rouge">Refresh Token</code>æœºåˆ¶</p>

<h2 id="refresh-token">Refresh Token</h2>

<p><code class="language-plaintext highlighter-rouge">Refresh Token</code>çš„ä½œç”¨æ˜¯ç”¨æ¥åˆ·æ–°<code class="language-plaintext highlighter-rouge">Access Token</code>ã€‚è®¤è¯æœåŠ¡å™¨æä¾›ä¸€ä¸ªåˆ·æ–°æ¥å£ï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>http://www.tangyuewei.com/refresh?refresh_token=&amp;client_id=
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ä¼ å…¥<code class="language-plaintext highlighter-rouge">refresh_token</code> å’Œ <code class="language-plaintext highlighter-rouge">client_id</code>ï¼Œè®¤è¯æœåŠ¡å™¨éªŒè¯é€šè¿‡åï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ Access Tokenã€‚ä¸ºäº†å®‰å…¨ï¼ŒoAuth2.0 å¼•å…¥äº†ä¸¤ä¸ªæªæ–½ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">oAuth2.0</code>è¦æ±‚ï¼Œ<code class="language-plaintext highlighter-rouge">Refresh Token</code> <b>ä¸€å®šæ˜¯ä¿å­˜åœ¨å®¢æˆ·ç«¯çš„æœåŠ¡å™¨ä¸Š</b> ï¼Œè€Œç»ä¸èƒ½å­˜æ”¾åœ¨ç‹­ä¹‰çš„å®¢æˆ·ç«¯ï¼ˆä¾‹å¦‚ Appã€PC ç«¯è½¯ä»¶ï¼‰ä¸Šã€‚è°ƒç”¨ <code class="language-plaintext highlighter-rouge">refresh</code> æ¥å£çš„æ—¶å€™ï¼Œä¸€å®šæ˜¯ä»æœåŠ¡å™¨åˆ°æœåŠ¡å™¨çš„è®¿é—®ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">oAuth2.0</code>å¼•å…¥äº†<code class="language-plaintext highlighter-rouge">client_secret</code>æœºåˆ¶ã€‚å³æ¯ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">client_id</code>éƒ½å¯¹åº”ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">client_secret</code>ã€‚è¿™ä¸ª <code class="language-plaintext highlighter-rouge">client_secret</code> ä¼šåœ¨å®¢æˆ·ç«¯ç”³è¯·<code class="language-plaintext highlighter-rouge">client_id</code>æ—¶ï¼Œéš<code class="language-plaintext highlighter-rouge">client_id</code>ä¸€èµ·åˆ†é…ç»™å®¢æˆ·ç«¯ã€‚<b>å®¢æˆ·ç«¯å¿…é¡»æŠŠ <code class="language-plaintext highlighter-rouge">client_secret</code> å¦¥å–„ä¿ç®¡åœ¨æœåŠ¡å™¨ä¸Š</b>ï¼Œå†³ä¸èƒ½æ³„éœ²ã€‚åˆ·æ–°<code class="language-plaintext highlighter-rouge">Access Token</code>æ—¶ï¼Œéœ€è¦éªŒè¯è¿™ä¸ª<code class="language-plaintext highlighter-rouge"> client_secret</code>ã€‚
å®é™…ä¸Šçš„åˆ·æ–°æ¥å£ç±»ä¼¼äºï¼š
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>http://www.tangyuewei.com/refresh?refresh_token=&amp;client_id=&amp;client_secret=
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p>ä»¥ä¸Šå°±æ˜¯<code class="language-plaintext highlighter-rouge">Refresh Token</code>æœºåˆ¶ã€‚<code class="language-plaintext highlighter-rouge">Refresh Token</code>çš„æœ‰æ•ˆæœŸéå¸¸é•¿ï¼Œä¼šåœ¨ç”¨æˆ·æˆæƒæ—¶ï¼Œéš<code class="language-plaintext highlighter-rouge">Access Token</code>ä¸€èµ·é‡å®šå‘åˆ°å›è°ƒ<code class="language-plaintext highlighter-rouge">URL</code>ï¼Œä¼ é€’ç»™å®¢æˆ·ç«¯ã€‚</p>
  </li>
</ul>

<h1 id="å®¢æˆ·ç«¯æˆæƒæ¨¡å¼">å®¢æˆ·ç«¯æˆæƒæ¨¡å¼</h1>

<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>

<p>å®¢æˆ·ç«¯å¿…é¡»å¾—åˆ°ç”¨æˆ·çš„æˆæƒï¼ˆauthorization grantï¼‰ï¼Œæ‰èƒ½è·å¾—ä»¤ç‰Œï¼ˆaccess tokenï¼‰ã€‚oAuth 2.0 å®šä¹‰äº†å››ç§æˆæƒæ–¹å¼ã€‚</p>

<ul>
  <li>implicitï¼šç®€åŒ–æ¨¡å¼ï¼Œä¸æ¨èä½¿ç”¨</li>
  <li>authorization codeï¼šæˆæƒç æ¨¡å¼</li>
  <li>resource owner password credentialsï¼šå¯†ç æ¨¡å¼</li>
  <li>client credentialsï¼šå®¢æˆ·ç«¯æ¨¡å¼</li>
</ul>

<h2 id="ç®€åŒ–æ¨¡å¼">ç®€åŒ–æ¨¡å¼</h2>

<p>ç®€åŒ–æ¨¡å¼é€‚ç”¨äºçº¯é™æ€é¡µé¢åº”ç”¨ã€‚æ‰€è°“çº¯é™æ€é¡µé¢åº”ç”¨ï¼Œä¹Ÿå°±æ˜¯åº”ç”¨æ²¡æœ‰åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»£ç çš„æƒé™ï¼ˆé€šå¸¸æ˜¯æŠŠä»£ç æ‰˜ç®¡åœ¨åˆ«äººçš„æœåŠ¡å™¨ä¸Šï¼‰ï¼Œåªæœ‰å‰ç«¯ JS ä»£ç çš„æ§åˆ¶æƒã€‚</p>

<p>è¿™ç§åœºæ™¯ä¸‹ï¼Œåº”ç”¨æ˜¯æ²¡æœ‰æŒä¹…åŒ–å­˜å‚¨çš„èƒ½åŠ›çš„ã€‚å› æ­¤ï¼ŒæŒ‰ç…§<code class="language-plaintext highlighter-rouge">oAuth2.0</code>çš„è§„å®šï¼Œè¿™ç§åº”ç”¨æ˜¯æ‹¿ä¸åˆ°<code class="language-plaintext highlighter-rouge">Refresh Token</code>çš„ã€‚
è¯¥æ¨¡å¼ä¸‹ï¼Œ<code class="language-plaintext highlighter-rouge">access_token</code>å®¹æ˜“æ³„éœ²ä¸”ä¸å¯åˆ·æ–°</p>

<h2 id="æˆæƒç æ¨¡å¼">æˆæƒç æ¨¡å¼</h2>

<p>æˆæƒç æ¨¡å¼é€‚ç”¨äºæœ‰è‡ªå·±çš„æœåŠ¡å™¨çš„åº”ç”¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸€æ¬¡æ€§çš„ä¸´æ—¶å‡­è¯ï¼Œç”¨æ¥æ¢å–<code class="language-plaintext highlighter-rouge">access_token</code>å’Œ<code class="language-plaintext highlighter-rouge">refresh_token</code>ã€‚è®¤è¯æœåŠ¡å™¨æä¾›äº†ä¸€ä¸ªç±»ä¼¼è¿™æ ·çš„æ¥å£ï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>https://www.tangyuewei.com/exchange?code=&amp;client_id=&amp;client_secret=
</pre></td></tr></tbody></table></code></pre></div></div>
<p>éœ€è¦ä¼ å…¥<code class="language-plaintext highlighter-rouge">code</code>ã€<code class="language-plaintext highlighter-rouge">client_id</code>ä»¥åŠ<code class="language-plaintext highlighter-rouge">client_secret</code>ã€‚éªŒè¯é€šè¿‡åï¼Œè¿”å›<code class="language-plaintext highlighter-rouge">access_token</code>å’Œ<code class="language-plaintext highlighter-rouge">refresh_token</code>ã€‚ä¸€æ—¦æ¢å–æˆåŠŸï¼Œ<code class="language-plaintext highlighter-rouge">code</code>ç«‹å³ä½œåºŸï¼Œä¸èƒ½å†ä½¿ç”¨ç¬¬äºŒæ¬¡ã€‚
è¿™ä¸ª<code class="language-plaintext highlighter-rouge">code</code>çš„ä½œç”¨æ˜¯ä¿æŠ¤<code class="language-plaintext highlighter-rouge">token</code>çš„å®‰å…¨æ€§ã€‚ç®€å•æ¨¡å¼ä¸‹ï¼Œ<code class="language-plaintext highlighter-rouge">token</code>æ˜¯ä¸å®‰å…¨çš„ã€‚è¿™æ˜¯å› ä¸ºåœ¨ç¬¬ 4 æ­¥å½“ä¸­ç›´æ¥æŠŠ<code class="language-plaintext highlighter-rouge">token</code>è¿”å›ç»™åº”ç”¨ã€‚è€Œè¿™ä¸€æ­¥å®¹æ˜“è¢«æ‹¦æˆªã€çªƒå¬ã€‚å¼•å…¥äº†<code class="language-plaintext highlighter-rouge">code</code>ä¹‹åï¼Œå³ä½¿æ”»å‡»è€…èƒ½å¤Ÿçªƒå–åˆ°<code class="language-plaintext highlighter-rouge">code</code>ï¼Œä½†æ˜¯ç”±äºä»–æ— æ³•è·å¾—åº”ç”¨ä¿å­˜åœ¨æœåŠ¡å™¨çš„<code class="language-plaintext highlighter-rouge">client_secret</code>ï¼Œå› æ­¤ä¹Ÿæ— æ³•é€šè¿‡<code class="language-plaintext highlighter-rouge">code</code>æ¢å–<code class="language-plaintext highlighter-rouge">token</code>ã€‚è€Œç¬¬ 5 æ­¥ï¼Œä¸ºä»€ä¹ˆä¸å®¹æ˜“è¢«æ‹¦æˆªã€çªƒå¬å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºï¼Œé¦–å…ˆï¼Œè¿™æ˜¯ä¸€ä¸ªä»æœåŠ¡å™¨åˆ°æœåŠ¡å™¨çš„è®¿é—®ï¼Œé»‘å®¢æ¯”è¾ƒéš¾æ•æ‰åˆ°ï¼›å…¶æ¬¡ï¼Œè¿™ä¸ªè¯·æ±‚é€šå¸¸è¦æ±‚æ˜¯<code class="language-plaintext highlighter-rouge">https</code>çš„å®ç°ã€‚å³ä½¿èƒ½çªƒå¬åˆ°æ•°æ®åŒ…ä¹Ÿæ— æ³•è§£æå‡ºå†…å®¹ã€‚</p>

<p>æœ‰äº†è¿™ä¸ª<code class="language-plaintext highlighter-rouge">code</code>ï¼Œ<code class="language-plaintext highlighter-rouge">token </code>çš„å®‰å…¨æ€§å¤§å¤§æé«˜ã€‚å› æ­¤ï¼Œ<code class="language-plaintext highlighter-rouge">oAuth2.0</code>é¼“åŠ±ä½¿ç”¨è¿™ç§æ–¹å¼è¿›è¡Œæˆæƒï¼Œè€Œç®€å•æ¨¡å¼åˆ™æ˜¯åœ¨ä¸å¾—å·²æƒ…å†µä¸‹æ‰ä¼šä½¿ç”¨ã€‚</p>

<h2 id="å¯†ç æ¨¡å¼">å¯†ç æ¨¡å¼</h2>

<p>å¯†ç æ¨¡å¼ä¸­ï¼Œç”¨æˆ·å‘å®¢æˆ·ç«¯æä¾›è‡ªå·±çš„ç”¨æˆ·åå’Œå¯†ç ã€‚å®¢æˆ·ç«¯ä½¿ç”¨è¿™äº›ä¿¡æ¯ï¼Œå‘ â€œæœåŠ¡å•†æä¾›å•†â€ ç´¢è¦æˆæƒã€‚åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼Œç”¨æˆ·å¿…é¡»æŠŠè‡ªå·±çš„å¯†ç ç»™å®¢æˆ·ç«¯ï¼Œä½†æ˜¯å®¢æˆ·ç«¯ä¸å¾—å‚¨å­˜å¯†ç ã€‚è¿™é€šå¸¸ç”¨åœ¨ç”¨æˆ·å¯¹å®¢æˆ·ç«¯é«˜åº¦ä¿¡ä»»çš„æƒ…å†µä¸‹ï¼Œæ¯”å¦‚å®¢æˆ·ç«¯æ˜¯æ“ä½œç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ã€‚</p>

<p>ä¸€ä¸ªå…¸å‹çš„ä¾‹å­æ˜¯åŒä¸€ä¸ªä¼ä¸šå†…éƒ¨çš„ä¸åŒäº§å“è¦ä½¿ç”¨æœ¬ä¼ä¸šçš„<code class="language-plaintext highlighter-rouge">oAuth2.0</code>ä½“ç³»ã€‚åœ¨æœ‰äº›æƒ…å†µä¸‹ï¼Œäº§å“å¸Œæœ›èƒ½å¤Ÿå®šåˆ¶åŒ–æˆæƒé¡µé¢ã€‚ç”±äºæ˜¯åŒä¸ªä¼ä¸šï¼Œä¸éœ€è¦å‘ç”¨æˆ·å±•ç¤ºâ€œxxxå°†è·å–ä»¥ä¸‹æƒé™â€ç­‰å­—æ ·å¹¶è¯¢é—®ç”¨æˆ·çš„æˆæƒæ„å‘ï¼Œè€Œåªéœ€è¿›è¡Œç”¨æˆ·çš„èº«ä»½è®¤è¯å³å¯ã€‚è¿™ä¸ªæ—¶å€™ï¼Œç”±å…·ä½“çš„äº§å“å›¢é˜Ÿå¼€å‘å®šåˆ¶åŒ–çš„æˆæƒç•Œé¢ï¼Œæ¥æ”¶ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç ï¼Œå¹¶ç›´æ¥ä¼ é€’ç»™é‰´æƒæœåŠ¡å™¨è¿›è¡Œæˆæƒå³å¯ã€‚</p>

<h2 id="å®¢æˆ·ç«¯æ¨¡å¼">å®¢æˆ·ç«¯æ¨¡å¼</h2>

<p>å¦‚æœä¿¡ä»»å…³ç³»å†è¿›ä¸€æ­¥ï¼Œæˆ–è€…è°ƒç”¨è€…æ˜¯ä¸€ä¸ªåç«¯çš„æ¨¡å—ï¼Œæ²¡æœ‰ç”¨æˆ·ç•Œé¢çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨å®¢æˆ·ç«¯æ¨¡å¼ã€‚é‰´æƒæœåŠ¡å™¨ç›´æ¥å¯¹å®¢æˆ·ç«¯è¿›è¡Œèº«ä»½éªŒè¯ï¼ŒéªŒè¯é€šè¿‡åï¼Œè¿”å›<code class="language-plaintext highlighter-rouge">token</code>ã€‚</p>]]></content><author><name>tangyuewei</name></author><category term="å¸¸ç”¨æ¡†æ¶" /><category term="oAuth2" /><category term="Spring Security" /><summary type="html"><![CDATA[ä»€ä¹ˆæ˜¯ oAuth]]></summary></entry><entry><title type="html">2022ä¸2023</title><link href="https://tangyuewei.github.io/posts/2022%E4%B8%8E2023/" rel="alternate" type="text/html" title="2022ä¸2023" /><published>2023-01-06T10:00:00+08:00</published><updated>2023-01-06T10:00:00+08:00</updated><id>https://tangyuewei.github.io/posts/2022%E4%B8%8E2023</id><content type="html" xml:base="https://tangyuewei.github.io/posts/2022%E4%B8%8E2023/"><![CDATA[<h2 id="2023">2023</h2>

<blockquote>
  <p>å…‰é˜´ä¼¼ç®­ï¼Œå²æœˆå¦‚æ¢­</p>
</blockquote>

<blockquote>
  <p>ä¸ç¦æ„Ÿå¹ï¼Œæ—¶é—´å¦‚æ­¤ä¹‹å¿«</p>
</blockquote>

<blockquote>
  <p>å›é¦–è¿™ä¸€å¹´ï¼Œæ‰‹é‡Œçš„å¥½ç‰Œè¶Šæ‰“è¶Šçƒ‚ï¼Œåˆ°å‘ç°éƒ½æ˜¯çƒ‚ç‰Œæ—¶æ‰æƒ³ç€å¦‚ä½•æ‰“å¥½</p>
</blockquote>

<blockquote>
  <p>å¹´åˆæ—¶ï¼Œå‘¨è€Œå¤å§‹ï¼Œå¹³æ·¡æ— å¥‡ï¼ŒåŠå¹´å¦‚ä¸€æ—¥</p>
</blockquote>

<blockquote>
  <p>å¹´ä¸­æ—¶ï¼Œæ‰å‘ç°è‡ªå·±å¤ªè¿‡æ·±æƒ…ï¼Œå› ä¸ºå¾€å¾€éƒ½æ˜¯æ·±æƒ…è‡³æçš„äººæ‰èƒ½ä¸Šå½“å—éª—</p>
</blockquote>

<blockquote>
  <p>å¹´æœ«æ—¶ï¼Œç–«æƒ…ä¸‰å¹´ï¼Œçªç„¶çš„æ”¾å¼€ï¼ŒçŒä¸åŠé˜²ï¼Œæœ€åä¸€å‘¨ï¼ŒğŸäº†ä¸ªğŸ</p>
</blockquote>

<blockquote>
  <p>2023å¹´äº†ï¼ŒåŸæœ¬ä»¥ä¸ºå‰é¢é‚£å‡ å¹´å·²æ…¢æ…¢åœ¨èµ°å‡ºä½è°·ï¼Œæ‰å‘ç°ä¸€ç›´åœæ»ä¸å‰</p>
</blockquote>

<blockquote>
  <p>Tomorrow will be better. Come on T Y W.</p>
</blockquote>

<blockquote>
  <p>æ¥ä¸‹æ¥çš„å‡ å¹´é‡Œï¼Œå‡†å¤‡å¥½è“„åŠ¿å¾…å‘ï¼Œè¯»ä¸‡å·ä¹¦ï¼Œè¡Œä¸‡é‡Œè·¯ï¼Œé˜…äººæ— æ•°</p>
</blockquote>

<blockquote>
  <p>æ„¿å†å°½åƒå¸†ï¼Œå½’æ¥ä»æ˜¯å°‘å¹´</p>
</blockquote>

<blockquote>
  <p>ç ¥ç ºå‰è¡Œï¼Œæœªæ¥å¯æœŸï¼ŒT Y W ğŸ„ ğŸ…±ï¸</p>
</blockquote>]]></content><author><name>tangyuewei</name></author><category term="åšå®¢é‚£äº›äº‹" /><category term="æ€»ç»“" /><summary type="html"><![CDATA[2023]]></summary></entry><entry><title type="html">springbootå‡çº§2.7åï¼Œæ— æ³•è®¾ç½®è·¨åŸŸçš„é—®é¢˜</title><link href="https://tangyuewei.github.io/posts/spring-cors/" rel="alternate" type="text/html" title="springbootå‡çº§2.7åï¼Œæ— æ³•è®¾ç½®è·¨åŸŸçš„é—®é¢˜" /><published>2022-08-12T14:00:00+08:00</published><updated>2022-08-12T14:00:00+08:00</updated><id>https://tangyuewei.github.io/posts/spring%20cors</id><content type="html" xml:base="https://tangyuewei.github.io/posts/spring-cors/"><![CDATA[<h2 id="æè¿°">æè¿°</h2>
<p>è·¨åŸŸæ˜¯åç«¯æ¥å£å¿…é¡»å¤„ç†çš„é—®é¢˜ï¼Œæ–°æ­å»ºçš„æœåŠ¡ä½¿ç”¨<code class="language-plaintext highlighter-rouge">SpringBoot</code>çš„ç‰ˆæœ¬ä¸º<code class="language-plaintext highlighter-rouge">2.7.0</code>ã€‚ä½¿ç”¨postmanè¯·æ±‚æ¥å£æ—¶ä¸å¸¦<code class="language-plaintext highlighter-rouge">origin</code>ï¼Œæ¥å£éƒ½æ˜¯å¯ä»¥æ­£å¸¸è¿”å›çš„ï¼Œ
å½“åŠ ä¸Šäº†<code class="language-plaintext highlighter-rouge">origin</code>åï¼Œå°±æŠ¥é”™äº†ï¼ŒæŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>java.lang.IllegalArgumentException: When allowCredentials is true, allowedOrigins cannot contain the special value "*" since that cannot be set on the "Access-Control-Allow-Origin" response header. To allow credentials to a set of origins, list them explicitly or consider using "allowedOriginPatterns" instead.
	at org.springframework.web.cors.CorsConfiguration.validateAllowCredentials(CorsConfiguration.java:475)
	at org.springframework.web.cors.CorsConfiguration.checkOrigin(CorsConfiguration.java:579)
	at org.springframework.web.cors.DefaultCorsProcessor.checkOrigin(DefaultCorsProcessor.java:174)
	at org.springframework.web.cors.DefaultCorsProcessor.handleInternal(DefaultCorsProcessor.java:116)
	at org.springframework.web.cors.DefaultCorsProcessor.processRequest(DefaultCorsProcessor.java:95)
	at org.springframework.web.filter.CorsFilter.doFilterInternal(CorsFilter.java:87)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:117)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:189)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:162)
</pre></td></tr></tbody></table></code></pre></div></div>
<p>æˆ‘ä»¬åˆå§‹çš„è·¨åŸŸè®¾ç½®æ˜¯è¿™æ ·çš„</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="nd">@EnableWebMvc</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CORSConfig</span> <span class="kd">implements</span> <span class="nc">WebMvcConfigurer</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addCorsMappings</span><span class="o">(</span><span class="nc">CorsRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">addMapping</span><span class="o">(</span><span class="s">"/**"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">allowedOrigins</span><span class="o">(</span><span class="s">"*"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">allowedMethods</span><span class="o">(</span><span class="s">"GET"</span><span class="o">,</span> <span class="s">"HEAD"</span><span class="o">,</span> <span class="s">"POST"</span><span class="o">,</span> <span class="s">"PUT"</span><span class="o">,</span> <span class="s">"DELETE"</span><span class="o">,</span> <span class="s">"OPTIONS"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">allowCredentials</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
                <span class="o">.</span><span class="na">allowedHeaders</span><span class="o">(</span><span class="s">"*"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">maxAge</span><span class="o">(</span><span class="mi">1800L</span><span class="o">);</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>æ ¹æ®æŠ¥é”™çš„ä¿¡æ¯æç¤ºï¼Œæˆ‘ä»¬å°†<code class="language-plaintext highlighter-rouge">allowedOrigins</code>ä¿®æ”¹ä¸º<code class="language-plaintext highlighter-rouge">allowedOriginPatterns</code></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="nd">@EnableWebMvc</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CORSConfig</span> <span class="kd">implements</span> <span class="nc">WebMvcConfigurer</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addCorsMappings</span><span class="o">(</span><span class="nc">CorsRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">addMapping</span><span class="o">(</span><span class="s">"/**"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">allowedOriginPatterns</span><span class="o">(</span><span class="s">"*"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">allowedMethods</span><span class="o">(</span><span class="s">"GET"</span><span class="o">,</span> <span class="s">"HEAD"</span><span class="o">,</span> <span class="s">"POST"</span><span class="o">,</span> <span class="s">"PUT"</span><span class="o">,</span> <span class="s">"DELETE"</span><span class="o">,</span> <span class="s">"OPTIONS"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">allowCredentials</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
                <span class="o">.</span><span class="na">allowedHeaders</span><span class="o">(</span><span class="s">"*"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">maxAge</span><span class="o">(</span><span class="mi">1800L</span><span class="o">);</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¯åŠ¨åº”ç”¨è®¿é—®ï¼Œåº”è¯¥å°±è§£å†³äº†ã€‚å½“è¿˜æ˜¯æŠ¥ç›¸åŒçš„é”™è¯¯ã€‚æˆ‘ä»¬è”ç³»äº†å‰ç«¯å’Œè¿ç»´ï¼Œåœ¨<code class="language-plaintext highlighter-rouge">js</code>å’Œ<code class="language-plaintext highlighter-rouge">nginx</code>ç«¯éƒ½ä½œäº†å¤„ç†ï¼Œä¾ç„¶æ— æµäºäº‹ã€‚</p>

<blockquote>
  <p>è¿˜å‘ç°ä¸€ä¸ªè¯¡å¼‚çš„é—®é¢˜ï¼Œæ— è®ºæˆ‘æœ¬åœ°å¦‚ä½•ä¸Šè¿°è·¨åŸŸè®¾ç½®ï¼Œéƒ½æŠ¥ä¸Šé¢ç›¸åŒçš„é”™è¯¯ã€‚</p>
</blockquote>

<blockquote>
  <p>å› ä¸ºçº¿ä¸Šè¦ä½¿ç”¨ï¼Œè¢«è¿«ç”¨å…¶ä»–è§£å†³æ–¹æ¡ˆç´§æ€¥å¤„ç†æ‰ã€‚åæ¥å‘ç°ç¥é˜Ÿå‹å±…ç„¶åœ¨<code class="language-plaintext highlighter-rouge">springboot</code>çš„å¯åŠ¨ç±»ä¸­åˆå†™äº†ä¸ªè·¨åŸŸçš„è®¾ç½®<code class="language-plaintext highlighter-rouge">Bean</code>ã€‚æ‰€ä»¥
å‡ºç°å¦‚ä¸‹æƒ…å†µä¹Ÿå°±ä¸å¥‡æ€ªäº†ï¼Œå†æ¬¡æç¤ºåŠ¡å¿…è§„èŒƒç¼–ç ï¼Œä¸ç„¶æ’æŸ¥é”™è¯¯éƒ½èƒ½æŠŠäººæ•´æ‡µé€¼ã€‚-_-||</p>
</blockquote>

<p>äºæ˜¯æˆ‘æœ¬åœ°<code class="language-plaintext highlighter-rouge">debug</code>è®¾ç½®äº†æ–­ç‚¹åœ¨<code class="language-plaintext highlighter-rouge">CorsConfiguration.java:475</code>çš„<code class="language-plaintext highlighter-rouge">CorsConfiguration.validateAllowCredentials</code>æ–¹æ³•ã€‚</p>

<p>å‘ç°ä¸€æ¬¡è¯·æ±‚è¿›äº†ä¸¤æ¬¡æ–­ç‚¹ã€‚å…¶ä¸­æœ‰ä¸€æ¬¡<code class="language-plaintext highlighter-rouge">if (this.allowCredentials == Boolean.TRUE &amp;&amp;
this.allowedOrigins != null &amp;&amp; this.allowedOrigins.contains(ALL))</code>åˆ¤æ–­æ˜¯é€šè¿‡çš„ï¼Œæ˜¾ç¤º<code class="language-plaintext highlighter-rouge">this.allowedOrigins</code>çš„å€¼ä¸ºâ€*â€;
æ‰€ä»¥å°±æŠ›äº†è¿™å¼‚å¸¸<code class="language-plaintext highlighter-rouge">java.lang.IllegalArgumentException: When allowCredentials is true, allowedOrigins cannot contain the special value "*" since that cannot be set on the "Access-Control-Allow-Origin" response header. To allow credentials to a set of origins, list them explicitly or consider using "allowedOriginPatterns" instead</code>ã€‚</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre>/**
 * Validate that when {@link #setAllowCredentials allowCredentials} is true,
 * {@link #setAllowedOrigins allowedOrigins} does not contain the special
 * value {@code "*"} since in that case the "Access-Control-Allow-Origin"
 * cannot be set to {@code "*"}.
 * @throws IllegalArgumentException if the validation fails
 * @since 5.3
 */
public void validateAllowCredentials() {
		if (this.allowCredentials == Boolean.TRUE &amp;&amp;
				this.allowedOrigins != null &amp;&amp; this.allowedOrigins.contains(ALL)) {

			throw new IllegalArgumentException(
        "When allowCredentials is true, allowedOrigins cannot contain the special value \"*\" " +
          "since that cannot be set on the \"Access-Control-Allow-Origin\" response header. " +
          "To allow credentials to a set of origins, list them explicitly " +
          "or consider using \"allowedOriginPatterns\" instead.");
		}
}
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å…¶ä»–è§£å†³æ–¹æ¡ˆ">å…¶ä»–è§£å†³æ–¹æ¡ˆ</h2>
<ol>
  <li>é™çº§<code class="language-plaintext highlighter-rouge">springboot</code>çš„ç‰ˆæœ¬åˆ°<code class="language-plaintext highlighter-rouge">2.3.x</code>ï¼ˆæ¨èï¼‰
    <blockquote>
      <p>ä¹‹å‰æˆ‘ä»¬ä½¿ç”¨<code class="language-plaintext highlighter-rouge">springboot</code>çš„<code class="language-plaintext highlighter-rouge">2.3.12.RELEASE</code>æ—¶ï¼Œè®¾ç½®è·¨åŸŸæ˜¯ä¸èƒ½<code class="language-plaintext highlighter-rouge">allowedOriginPatterns</code>çš„ï¼Œæ¥å£ä¹Ÿæ˜¯æ­£å¸¸ï¼Œå¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">maven</code>ç®¡ç†<code class="language-plaintext highlighter-rouge">pom.xml</code>
å…ˆé™çº§åˆ°<code class="language-plaintext highlighter-rouge">2.3.x</code>çš„ç‰ˆæœ¬ã€‚</p>
    </blockquote>
  </li>
  <li>å°†<code class="language-plaintext highlighter-rouge">CorsConfiguration.java</code>ä¸­<code class="language-plaintext highlighter-rouge">CorsConfiguration.validateAllowCredentials</code>æ–¹æ³•çš„æŠ›å¼‚å¸¸æ³¨é‡Šæ‰
å› ä¸ºæˆ‘ä»¬ç›®å‰ç”¨çš„æ˜¯<code class="language-plaintext highlighter-rouge">2.7.0</code>ç‰ˆæœ¬ï¼Œå¹¶ä¸”ä½¿ç”¨äº†å¤šæ•°æ®æºç‰¹æ€§ï¼Œä½¿ç”¨<code class="language-plaintext highlighter-rouge">maven</code>é™çº§åå¯åŠ¨ä¼šæŠ¥é”™ã€‚ä¿®æ”¹å¤šæ•°æ®æºçš„ä»£ä»·è¿˜æ˜¯å¾ˆå¤§çš„ï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©é‡å†™
<code class="language-plaintext highlighter-rouge">validateAllowCredentials</code>æ–¹æ³•ã€‚
    <ul>
      <li>é¦–å…ˆåœ¨é¡¹ç›®ä¸­æ–°å»º<code class="language-plaintext highlighter-rouge">org.springframework.web.cors</code>åŒ…</li>
      <li>åœ¨<code class="language-plaintext highlighter-rouge">org.springframework.web.cors</code>åŒ…ä¸­æ–°å»º<code class="language-plaintext highlighter-rouge">CorsConfiguration.java</code>ç±»</li>
      <li>å°†<code class="language-plaintext highlighter-rouge">CorsConfiguration.class</code>ä¸­çš„ä»£ç å¤åˆ¶åˆ°æœ¬åœ°ä¸­ï¼Œä¿®æ”¹<code class="language-plaintext highlighter-rouge">validateAllowCredentials</code>æ–¹æ³•ï¼Œæ³¨é‡Š<code class="language-plaintext highlighter-rouge">throw new
IllegalArgumentException(When allowCredentials is true, allowedOrigins cannot contain the special value ...)</code></li>
      <li>å¯åŠ¨é¡¹ç›®è®¿é—®è§£å†³äº†ã€‚
        <blockquote>
          <p><code class="language-plaintext highlighter-rouge">java</code>åŠ è½½ç±»é‡‡ç”¨å°±è¿‘åŸåˆ™ï¼Œæ•…å¯ä»¥è¿›è¡Œè¦†ç›–ã€‚</p>
        </blockquote>
      </li>
    </ul>
  </li>
</ol>]]></content><author><name>tangyuewei</name></author><category term="Spring Boot" /><category term="Spring Boot" /><summary type="html"><![CDATA[æè¿° è·¨åŸŸæ˜¯åç«¯æ¥å£å¿…é¡»å¤„ç†çš„é—®é¢˜ï¼Œæ–°æ­å»ºçš„æœåŠ¡ä½¿ç”¨SpringBootçš„ç‰ˆæœ¬ä¸º2.7.0ã€‚ä½¿ç”¨postmanè¯·æ±‚æ¥å£æ—¶ä¸å¸¦originï¼Œæ¥å£éƒ½æ˜¯å¯ä»¥æ­£å¸¸è¿”å›çš„ï¼Œ å½“åŠ ä¸Šäº†originåï¼Œå°±æŠ¥é”™äº†ï¼ŒæŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ï¼š 1 2 3 4 5 6 7 8 9 10 java.lang.IllegalArgumentException: When allowCredentials is true, allowedOrigins cannot contain the special value "*" since that cannot be set on the "Access-Control-Allow-Origin" response header. To allow credentials to a set of origins, list them explicitly or consider using "allowedOriginPatterns" instead. at org.springframework.web.cors.CorsConfiguration.validateAllowCredentials(CorsConfiguration.java:475) at org.springframework.web.cors.CorsConfiguration.checkOrigin(CorsConfiguration.java:579) at org.springframework.web.cors.DefaultCorsProcessor.checkOrigin(DefaultCorsProcessor.java:174) at org.springframework.web.cors.DefaultCorsProcessor.handleInternal(DefaultCorsProcessor.java:116) at org.springframework.web.cors.DefaultCorsProcessor.processRequest(DefaultCorsProcessor.java:95) at org.springframework.web.filter.CorsFilter.doFilterInternal(CorsFilter.java:87) at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:117) at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:189) at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:162) æˆ‘ä»¬åˆå§‹çš„è·¨åŸŸè®¾ç½®æ˜¯è¿™æ ·çš„ ```java @Configuration @EnableWebMvc public class CORSConfig implements WebMvcConfigurer {]]></summary></entry></feed>